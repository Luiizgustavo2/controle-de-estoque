<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Nexus ERP - Business Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        :root { 
            /* Paleta Elegant Corporate */
            --primary-color: #6366f1; /* Indigo */
            --primary-light: #e0e7ff;
            --secondary-color: #64748b;
            
            --bg-body: #f8fafc;
            --sidebar-bg: #0f172a; 
            --surface: #ffffff;
            
            /* Cores dos Cards (Baseado no Bono, mas na paleta elegante) */
            --card-sales: #818cf8; 
            --card-credit: #34d399; 
            --card-received: #fbbf24; 
            --card-bills: #f87171; 

            --radius-md: 12px;
            --radius-lg: 16px;
            
            --shadow-subtle: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            
            --font-main: 'Plus Jakarta Sans', sans-serif;
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-body); 
            color: #334155; 
            overflow-x: hidden; 
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* SIDEBAR MINIMALISTA */
        .sidebar { 
            position: fixed; top: 0; left: 0; bottom: 0;
            width: 80px; 
            background: var(--sidebar-bg); 
            z-index: 1000; 
            display: flex; flex-direction: column; align-items: center;
            padding-top: 20px;
            transition: width 0.3s ease;
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
        }
        
        .sidebar:hover { width: 240px; align-items: flex-start; }
        .sidebar:hover .nav-link span { display: inline-block; opacity: 1; }
        .sidebar:hover .sidebar-brand span { display: block; }
        
        .sidebar-brand { margin-bottom: 30px; color: white; text-align: center; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; overflow: hidden;}
        .sidebar-brand span { display: none; font-weight: 700; font-size: 1.2rem; white-space: nowrap; }

        .nav-link { 
            color: #94a3b8; 
            margin: 8px 10px; 
            border-radius: var(--radius-md); 
            padding: 12px; 
            display: flex; align-items: center; 
            transition: 0.2s; 
            width: calc(100% - 20px);
            white-space: nowrap;
            overflow: hidden;
        }
        .nav-link i { font-size: 1.2rem; min-width: 24px; text-align: center; }
        .nav-link span { display: none; margin-left: 15px; opacity: 0; transition: opacity 0.2s; font-weight: 500; }
        
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: var(--primary-color); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

        /* MAIN CONTENT */
        main { margin-left: 80px; padding: 30px; transition: margin-left 0.3s; }
        @media(max-width: 768px) { main { margin-left: 0; padding-bottom: 80px; } .sidebar { bottom: 0; top: auto; width: 100%; height: 70px; flex-direction: row; justify-content: space-around; padding: 0; } .sidebar:hover { width: 100%; height: 70px; } .nav-link span { display: none !important; } }

        /* CARDS BONO STYLE */
        .kpi-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-card);
            display: flex;
            align-items: center;
            height: 100%;
            transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); }
        
        .kpi-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
            flex-shrink: 0;
        }

        /* ALERTAS (NOVO ESTILO) */
        .alert-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .alert-pill {
            background: white;
            border-radius: 50px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.9rem;
            white-space: nowrap;
            border: 1px solid transparent;
            transition: 0.2s;
            cursor: pointer;
        }
        .alert-pill:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .alert-danger-custom { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .alert-warning-custom { background: #fffbeb; border-color: #fde68a; color: #92400e; }
        .alert-success-custom { background: #ecfdf5; border-color: #a7f3d0; color: #065f46; cursor: default; }

        /* Summary Strip */
        .summary-strip {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 25px;
            margin-top: 25px;
        }
        .summary-item { border-right: 1px solid #e2e8f0; padding: 0 20px; }
        .summary-item:last-child { border-right: none; }
        .summary-label { font-size: 0.85rem; color: #64748b; margin-bottom: 5px; font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .summary-value { font-size: 1.5rem; font-weight: 700; color: #1e293b; letter-spacing: -0.5px; }

        /* UI ELEMENTS */
        .card-custom { border: none; border-radius: var(--radius-lg); background: var(--surface); box-shadow: var(--shadow-card); }
        .btn { border-radius: 8px; font-weight: 600; padding: 10px 20px; }
        .form-control { border-radius: 8px; padding: 10px 15px; background-color: #f8fafc; border: 1px solid #e2e8f0; }
        .form-control:focus { background-color: white; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        /* MOBILE */
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--sidebar-bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 24px; width: 100%; max-width: 400px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box fade-in">
        <div class="text-center mb-4">
            <div class="bg-primary text-white d-inline-flex p-3 rounded-4 mb-3"><i class="fas fa-layer-group fa-2x"></i></div>
            <h3 class="fw-bold">NEXUS ERP</h3>
            <p class="text-muted small">Gestão Inteligente</p>
        </div>
        <input type="email" id="email-login" class="form-control mb-3" placeholder="E-mail">
        <input type="password" id="senha-login" class="form-control mb-4" placeholder="Senha">
        <div class="d-grid gap-2">
            <button onclick="tentarLogin(this)" class="btn btn-primary btn-lg" style="background: var(--primary-color);">ENTRAR</button>
            <button onclick="entrarModoDemo(this)" class="btn btn-outline-secondary">Modo Demonstração</button>
        </div>
    </div>
</div>

<nav class="sidebar">
    <div class="sidebar-brand">
        <i class="fas fa-layer-group fa-2x text-primary"></i>
        <span>NEXUS</span>
    </div>
    
    <a class="nav-link active" onclick="navTo('dashboard')" title="Dashboard">
        <i class="fas fa-th-large"></i><span>Dashboard</span>
    </a>
    <a class="nav-link" onclick="navTo('pdv')" title="PDV / Vendas">
        <i class="fas fa-store"></i><span>Loja / PDV</span>
    </a>
    <a class="nav-link" onclick="navTo('fiados')" title="Clientes">
        <i class="fas fa-users"></i><span>Clientes</span>
    </a>
    <a class="nav-link" onclick="navTo('financeiro')" title="Financeiro">
        <i class="fas fa-wallet"></i><span>Carteira</span>
    </a>
    <a class="nav-link" onclick="navTo('estoque')" title="Produtos">
        <i class="fas fa-box-open"></i><span>Produtos</span>
    </a>
    <div style="margin-top: auto; margin-bottom: 20px; width: 100%; display: flex; flex-direction: column; align-items: center;">
        <a class="nav-link" onclick="navTo('config')" title="Configurações">
            <i class="fas fa-cog"></i><span>Ajustes</span>
        </a>
        <a class="nav-link text-danger" onclick="fazerLogout()" title="Sair">
            <i class="fas fa-sign-out-alt"></i><span>Sair</span>
        </a>
    </div>
</nav>

<main>
    <div class="container-fluid p-0" id="app-content" style="filter: blur(5px);">
        
        <div id="dashboard" class="section fade-in">
            <h4 class="fw-bold mb-4 text-dark">Dashboard</h4>
            
            <div class="row g-4 mb-4">
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: var(--primary-light); color: var(--primary-color);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold mb-0" id="card-vendas-dia">R$ 0,00</h4>
                            <small class="text-muted">Vendas do dia</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: #d1fae5; color: var(--card-credit);">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold mb-0" id="card-crediario-dia">R$ 0,00</h4>
                            <small class="text-muted">Vendas no crediário do dia</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: #fef3c7; color: var(--card-received);">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold mb-0" id="card-recebidos-dia">R$ 0,00</h4>
                            <small class="text-muted">Crediários recebidos do dia</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="background: #fee2e2; color: var(--card-bills);">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold mb-0" id="card-contas-dia">R$ 0,00</h4>
                            <small class="text-muted">Contas a pagar do dia</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="text-muted fw-bold small mb-2 text-uppercase" style="letter-spacing: 1px;">Central de Avisos</h6>
                <div id="painel-avisos" class="alert-container">
                    <div class="alert-pill alert-success-custom">
                        <i class="fas fa-check-circle"></i> Tudo em ordem! Sem pendências.
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card-custom p-4 h-100">
                        <h6 class="text-muted mb-4 small fw-bold">Vendas 2026 <i class="fas fa-info-circle ms-1"></i></h6>
                        <div style="height: 250px;">
                            <canvas id="graficoLinha"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card-custom p-4 h-100">
                        <h6 class="text-muted mb-4 small fw-bold">Formas de Pagamento (Mês) <i class="fas fa-info-circle ms-1"></i></h6>
                        <div style="height: 250px;">
                            <canvas id="graficoBarra"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-strip">
                <div class="row align-items-center">
                    <div class="col-md-3 summary-item">
                        <div class="summary-label">Vendas (mês) <i class="fas fa-info-circle text-muted" style="font-size: 0.7em;"></i></div>
                        <div class="summary-value" id="strip-vendas-mes">R$ 0,00</div>
                    </div>
                    <div class="col-md-3 summary-item">
                        <div class="summary-label">Custos/Saídas (mês) <i class="fas fa-info-circle text-muted" style="font-size: 0.7em;"></i></div>
                        <div class="summary-value text-danger" id="strip-custos-mes">R$ 0,00</div>
                    </div>
                    <div class="col-md-3 summary-item">
                        <div class="summary-label">Margem de contribuição <i class="fas fa-info-circle text-muted" style="font-size: 0.7em;"></i></div>
                        <div class="summary-value text-success" id="strip-margem">R$ 0,00 <span class="badge bg-success bg-opacity-10 text-success fs-6 align-middle ms-2" id="strip-margem-pct">0%</span></div>
                    </div>
                    <div class="col-md-3 summary-item">
                        <div class="summary-label">Custo fixo Previsto <i class="fas fa-pen text-muted ms-auto" style="font-size: 0.7em; cursor: pointer;"></i></div>
                        <div class="summary-value" id="strip-custo-fixo">R$ 0,00</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pdv" class="section hide">
            <div class="row g-4 h-100">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold m-0">Caixa / PDV</h4>
                        <input type="text" id="pdv-search" class="form-control w-50" placeholder="Buscar produto..." onkeyup="renderPDVGrid()">
                    </div>
                    <div class="row g-3" id="pdv-grid"></div>
                </div>
                <div class="col-lg-4">
                    <div class="card-custom h-100 d-flex flex-column">
                        <div class="p-4 border-bottom d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold m-0">Carrinho</h5>
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="limparCarrinho()"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="p-3 flex-grow-1 overflow-auto" id="pdv-cart-items" style="max-height: 400px;"></div>
                        <div class="p-4 border-top bg-light mt-auto">
                            <div class="d-flex justify-content-between h3 fw-bold mb-3"><span>Total</span><span id="pdv-total" class="text-primary">R$ 0,00</span></div>
                            <button class="btn btn-primary w-100 btn-lg shadow-sm" onclick="abrirModalPagamento()">FINALIZAR VENDA</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fiados" class="section hide">
            <div class="d-flex justify-content-between mb-4"><h4 class="fw-bold">Gestão de Clientes</h4><button class="btn btn-primary" onclick="abrirModalNovoFiado()">+ Novo Cliente</button></div>
            <div class="card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light"><tr><th class="ps-4">Cliente</th><th>Status</th><th>Saldo</th><th class="text-end pe-4">Ações</th></tr></thead><tbody id="lista-fiados"></tbody></table></div></div>
        </div>
        <div id="financeiro" class="section hide">
            <div class="d-flex justify-content-between mb-4"><h4 class="fw-bold">Movimentações</h4><button class="btn btn-primary" onclick="abrirModalFinanca()">+ Lançar</button></div>
            <div class="card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light"><tr><th class="ps-4">Tipo</th><th>Descrição</th><th>Valor</th><th>Data</th><th class="text-end pe-4">Ações</th></tr></thead><tbody id="lista-financa"></tbody></table></div></div>
        </div>
        <div id="estoque" class="section hide">
            <div class="d-flex justify-content-between mb-4"><h4 class="fw-bold">Produtos</h4><button class="btn btn-primary" onclick="abrirModalProduto()">+ Novo Produto</button></div>
            <div class="card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light"><tr><th class="ps-4">Produto</th><th>Qtd</th><th>Preço Venda</th><th class="text-end pe-4">Ações</th></tr></thead><tbody id="lista-estoque"></tbody></table></div></div>
        </div>
        <div id="config" class="section hide">
             <div class="row justify-content-center"><div class="col-md-6"><div class="card-custom p-4"><h4 class="fw-bold mb-3">Configurações</h4><input type="text" id="conf-nome" class="form-control mb-3" placeholder="Nome da Loja"><button class="btn btn-success w-100" onclick="salvarConfig(this)">Salvar</button><hr><button class="btn btn-outline-danger w-100" onclick="resetarSistema()">Resetar Tudo</button></div></div></div>
        </div>

    </div>
</main>

<div class="modal fade" id="modalPagamento" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0"><div class="modal-body p-4"><h3 class="text-center fw-bold text-primary mb-4" id="modal-pag-total">R$ 0,00</h3><input type="text" id="cliente-pdv" class="form-control mb-3 text-center" placeholder="Cliente (Opcional)"><div class="row g-2 mb-3"><div class="col-6"><button class="btn btn-outline-secondary w-100 btn-pagamento" onclick="selectPagamento('Dinheiro', this)">Dinheiro</button></div><div class="col-6"><button class="btn btn-outline-secondary w-100 btn-pagamento" onclick="selectPagamento('PIX', this)">PIX</button></div><div class="col-6"><button class="btn btn-outline-secondary w-100 btn-pagamento" onclick="selectPagamento('Cartão', this)">Cartão</button></div><div class="col-6"><button class="btn btn-outline-danger w-100 btn-pagamento" onclick="selectPagamento('Fiado', this)">Fiado</button></div></div><input type="hidden" id="pag-metodo"><button class="btn btn-success w-100 btn-lg" onclick="processarVenda(this)">Confirmar</button></div></div></div></div>

<div class="modal fade" id="modalNovoFiado" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold">Novo Cliente</h5><input type="text" id="novo-fiado-nome" class="form-control mb-3" placeholder="Nome"><input type="number" id="novo-fiado-valor" class="form-control mb-3" placeholder="Dívida Inicial (0)"><button class="btn btn-primary w-100" onclick="criarNovoFiado(this)">Salvar</button></div></div></div></div>
<div class="modal fade" id="modalProduto" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold">Produto</h5><input type="hidden" id="prod-id"><input type="text" id="prod-nome" class="form-control mb-2" placeholder="Nome"><div class="row g-2 mb-3"><div class="col-4"><input type="number" id="prod-qtd" class="form-control" placeholder="Qtd"></div><div class="col-4"><input type="number" id="prod-custo" class="form-control" placeholder="Custo"></div><div class="col-4"><input type="number" id="prod-venda" class="form-control" placeholder="Venda"></div></div><button class="btn btn-primary w-100" onclick="salvarProduto(this)">Salvar</button></div></div></div></div>
<div class="modal fade" id="modalFinanca" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold">Lançamento</h5><input type="text" id="fin-desc" class="form-control mb-2" placeholder="Descrição"><select id="fin-tipo" class="form-select mb-2"><option value="entrada">Entrada</option><option value="saida">Saída</option></select><input type="number" id="fin-valor" class="form-control mb-3" placeholder="Valor"><button class="btn btn-success w-100" onclick="salvarFinanca(this)">Salvar</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBHBFj0QRebascuwJ5LxprYeuFbk7KsiYc", authDomain: "nexus-erp-6998c.firebaseapp.com", projectId: "nexus-erp-6998c", storageBucket: "nexus-erp-6998c.firebasestorage.app", messagingSenderId: "599369243365", appId: "1:599369243365:web:3363fe65f3d36c00e1d20c", measurementId: "G-7NFRRWYYJ6" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    db.enablePersistence({ synchronizeTabs: true }).catch(err => console.warn(err.code));
    const esc = (unsafe) => { if (!unsafe) return ''; return unsafe.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); };
    const norm = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    let currentUser = null, isDemoMode = false, produtos=[], financas=[], fiados=[], contas=[], carrinho=[];
    let chartLine = null, chartBar = null;

    // MOCK DB PARA DEMO
    const MockDB = {
        collection: (col) => ({
            doc: (id) => ({
                id: id || 'demo_'+Date.now(),
                set: async (data) => { if(col==='financas') financas.unshift({...data, id:'demo_'+Date.now()}); atualizarDashboard(); },
                update: async (data) => { atualizarDashboard(); },
                delete: async () => { atualizarDashboard(); }
            }),
            add: async (data) => { 
                const newId = 'demo_'+Date.now();
                if(col==='financas') financas.unshift({...data, id:newId});
                if(col==='produtos') produtos.push({...data, id:newId});
                if(col==='fiados') fiados.push({...data, id:newId});
                if(col==='contas') contas.push({...data, id:newId});
                atualizarDashboard(); return { id: newId };
            },
            onSnapshot: () => {}
        })
    };

    function getUserRef(c) { return isDemoMode ? MockDB.collection(c) : (currentUser ? db.collection("users").doc(currentUser.uid).collection(c) : null); }
    function setLoading(btn, isLoading) { if(isLoading) { btn.disabled=true; btn.orig=btn.innerHTML; btn.innerHTML='...'; } else { btn.disabled=false; btn.innerHTML=btn.orig; } }
    const formatCurrency = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);

    function entrarModoDemo() {
        isDemoMode = true; currentUser = { uid: 'demo' };
        document.getElementById('login-screen').classList.add('hide');
        document.getElementById('app-content').style.filter='none';
        
        financas = [
            {id:'1', tipo:'entrada', desc:'Venda Balcão', metodo:'Dinheiro', valor: 2500.00, dataISO: new Date().toISOString()},
            {id:'2', tipo:'entrada', desc:'Venda Loja', metodo:'Cartão', valor: 1500.00, dataISO: new Date().toISOString()},
            {id:'3', tipo:'entrada', desc:'Recebimento Fiado - João', metodo:'Dinheiro', valor: 119.75, dataISO: new Date().toISOString()},
            {id:'4', tipo:'entrada', desc:'Venda Crediário', metodo:'Fiado', valor: 239.50, dataISO: new Date().toISOString()},
            {id:'5', tipo:'saida', desc:'Fornecedor Bebidas', valor: 166.65, dataISO: new Date().toISOString()}
        ];
        contas = [
            {id:'1', desc:'Aluguel', valor: 500.00, venc: new Date().toISOString().split('T')[0], recorrente: true},
            {id:'2', desc:'Luz', valor: 450.00, venc: new Date().toISOString().split('T')[0], recorrente: false},
            {id:'3', desc:'Internet', valor: 100.00, venc: '2023-01-01', recorrente: false} // Exemplo vencido para teste
        ];
        produtos = [
            {id:'1', nome:'Exemplo Produto', qtd:100, custo:50, venda:100, min: 5},
            {id:'2', nome:'Produto Baixo', qtd:3, custo:10, venda:20, min: 5} // Exemplo baixo estoque
        ];
        atualizarDashboard(); navTo('dashboard');
    }

    auth.onAuthStateChanged(u => {
        if(u && !isDemoMode) { currentUser=u; document.getElementById('login-screen').classList.add('hide'); document.getElementById('app-content').style.filter='none'; iniciarSistema(); }
    });

    function iniciarSistema() {
        getUserRef("produtos").onSnapshot(s => { produtos = s.docs.map(d=>({id:d.id, ...d.data()})); atualizarDashboard(); });
        getUserRef("financas").orderBy("dataISO","desc").onSnapshot(s => { financas = s.docs.map(d=>({id:d.id, ...d.data()})); atualizarDashboard(); });
        getUserRef("fiados").onSnapshot(s => { fiados = s.docs.map(d=>({id:d.id, ...d.data()})); });
        getUserRef("contas").onSnapshot(s => { contas = s.docs.map(d=>({id:d.id, ...d.data()})); atualizarDashboard(); });
    }

    // --- LÓGICA DO DASHBOARD ---
    function atualizarDashboard() {
        const hojeISO = new Date().toISOString().split('T')[0];
        
        // 1. CARDS DO TOPO
        const transacoesHoje = financas.filter(f => f.dataISO.startsWith(hojeISO));
        
        const vendasDia = transacoesHoje.filter(f => f.tipo === 'entrada').reduce((acc, f) => acc + f.valor, 0);
        document.getElementById('card-vendas-dia').innerText = formatCurrency(vendasDia);

        const crediarioDia = transacoesHoje.filter(f => f.metodo === 'Fiado').reduce((acc, f) => acc + f.valor, 0);
        document.getElementById('card-crediario-dia').innerText = formatCurrency(crediarioDia);

        const recebidosDia = transacoesHoje.filter(f => f.desc.toLowerCase().includes('recebimento') || f.desc.toLowerCase().includes('dívida')).reduce((acc, f) => acc + f.valor, 0);
        document.getElementById('card-recebidos-dia').innerText = formatCurrency(recebidosDia);

        const contasDia = contas.filter(c => {
            let v = c.venc; 
            if(v.includes('/')) { const p = v.split('/'); v = `${p[2]}-${p[1]}-${p[0]}`; }
            return v === hojeISO;
        }).reduce((acc, c) => acc + c.valor, 0);
        document.getElementById('card-contas-dia').innerText = formatCurrency(contasDia);

        // 2. AVISOS E ALERTAS (NOVO)
        renderAlertas();

        // 3. FAIXA INFERIOR
        const mesAtual = new Date().getMonth();
        const transacoesMes = financas.filter(f => new Date(f.dataISO).getMonth() === mesAtual);
        
        const vendasMes = transacoesMes.filter(f => f.tipo === 'entrada').reduce((acc, f) => acc + f.valor, 0);
        document.getElementById('strip-vendas-mes').innerText = formatCurrency(vendasMes);

        const custosMes = transacoesMes.filter(f => f.tipo === 'saida').reduce((acc, f) => acc + f.valor, 0);
        document.getElementById('strip-custos-mes').innerText = formatCurrency(custosMes);

        const margem = vendasMes - custosMes;
        const margemPct = vendasMes > 0 ? ((margem / vendasMes) * 100).toFixed(1) : 0;
        document.getElementById('strip-margem').innerHTML = `${formatCurrency(margem)} <span class="badge bg-success bg-opacity-10 text-success fs-6 align-middle ms-2">${margemPct}%</span>`;

        const custoFixo = contas.filter(c => c.recorrente).reduce((acc, c) => acc + c.valor, 0);
        document.getElementById('strip-custo-fixo').innerText = formatCurrency(custoFixo);

        renderGraficos(vendasMes);
        renderListasSimples();
    }

    function renderAlertas() {
        const container = document.getElementById('painel-avisos');
        let html = '';
        let avisosCount = 0;

        // Avisos de Estoque
        produtos.filter(p => p.qtd <= (p.min || 5)).forEach(p => {
            html += `<div class="alert-pill alert-warning-custom" onclick="navTo('estoque')">
                <i class="fas fa-box text-warning"></i> <b>${esc(p.nome)}</b>: Baixo Estoque (${p.qtd})
            </div>`;
            avisosCount++;
        });

        // Avisos de Contas
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        contas.forEach(c => {
            const vencParts = c.venc.includes('/') ? c.venc.split('/') : c.venc.split('-');
            const dataVenc = new Date(vencParts[0].length===4 ? c.venc : `${vencParts[2]}-${vencParts[1]}-${vencParts[0]}`);
            const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
            
            if(diffDias < 0) {
                html += `<div class="alert-pill alert-danger-custom" onclick="navTo('contas')">
                    <i class="fas fa-exclamation-triangle text-danger"></i> <b>${esc(c.desc)}</b>: Venceu em ${c.venc}
                </div>`;
                avisosCount++;
            } else if (diffDias === 0) {
                html += `<div class="alert-pill alert-warning-custom" style="border-color: #f97316; color: #ea580c;" onclick="navTo('contas')">
                    <i class="fas fa-clock"></i> <b>${esc(c.desc)}</b>: Vence HOJE
                </div>`;
                avisosCount++;
            } else if (diffDias <= 3) {
                html += `<div class="alert-pill alert-warning-custom" onclick="navTo('contas')">
                    <i class="far fa-clock"></i> <b>${esc(c.desc)}</b>: Vence em ${diffDias} dias
                </div>`;
                avisosCount++;
            }
        });

        if(avisosCount === 0) {
            html = `<div class="alert-pill alert-success-custom"><i class="fas fa-smile"></i> Tudo tranquilo! Sem pendências urgentes.</div>`;
        }

        container.innerHTML = html;
    }

    function renderGraficos(vendasMesAtual) {
        const ctxLine = document.getElementById('graficoLinha');
        if(chartLine) chartLine.destroy();
        chartLine = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul'],
                datasets: [{
                    label: 'Vendas',
                    data: [12000, 15000, 8000, 16000, 5000, 42000, vendasMesAtual],
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168, 85, 247, 0.2)',
                    fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#fff', pointBorderColor: '#a855f7'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } }, x: { grid: { display: false } } } }
        });

        const metodos = {};
        financas.filter(f => f.tipo === 'entrada').forEach(f => {
            const m = f.metodo || 'Outros';
            if(!metodos[m]) metodos[m] = 0; metodos[m] += f.valor;
        });

        const ctxBar = document.getElementById('graficoBarra');
        if(chartBar) chartBar.destroy();
        chartBar = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: Object.keys(metodos),
                datasets: [{
                    label: 'Total', data: Object.values(metodos),
                    backgroundColor: ['#d8b4fe', '#9ca3af', '#fcd34d', '#fca5a5'],
                    borderRadius: 8, barThickness: 50
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { display: false }, x: { grid: { display: false } } } }
        });
    }

    // --- FUNÇÕES DE NAVEGAÇÃO E CRUD ---
    function navTo(id) { 
        document.querySelectorAll('.section').forEach(el=>el.classList.add('hide')); 
        document.getElementById(id).classList.remove('hide');
        document.querySelectorAll('.nav-link').forEach(el=>el.classList.remove('active'));
        if(event && event.currentTarget) event.currentTarget.classList.add('active');
        if(id==='dashboard') atualizarDashboard();
    }

    function renderPDVGrid() {
        const s = norm(document.getElementById('pdv-search').value);
        document.getElementById('pdv-grid').innerHTML = produtos.filter(p=>norm(p.nome).includes(s)).map(p => 
            `<div class="col-6 col-md-4"><div class="card-custom p-3 h-100" onclick="addCart('${p.id}')">
                <h6 class="fw-bold mb-1 text-truncate">${esc(p.nome)}</h6>
                <div class="h5 text-primary mb-0">${formatCurrency(p.venda)}</div>
                <small class="text-muted">Est: ${p.qtd}</small>
            </div></div>`
        ).join('');
    }
    function addCart(id) { const p=produtos.find(x=>x.id===id), i=carrinho.find(c=>c.id===id); if(i) i.qty++; else carrinho.push({...p, qty:1}); renderCart(); }
    function renderCart() { 
        document.getElementById('pdv-cart-items').innerHTML = carrinho.map(i => 
            `<div class="d-flex justify-content-between mb-2 small"><span>${i.qty}x ${esc(i.nome)}</span><span class="fw-bold">${formatCurrency(i.venda*i.qty)}</span></div>`
        ).join('');
        const total = carrinho.reduce((acc, i) => acc + i.venda*i.qty, 0);
        document.getElementById('pdv-total').innerText = formatCurrency(total);
        document.getElementById('modal-pag-total').innerText = formatCurrency(total);
    }
    function limparCarrinho() { carrinho=[]; renderCart(); }
    function selectPagamento(tipo, el) { document.getElementById('pag-metodo').value = tipo; document.querySelectorAll('.btn-pagamento').forEach(b=>b.classList.remove('btn-primary','text-white')); el.classList.add('btn-primary','text-white'); }
    
    async function processarVenda(btn) {
        const total = carrinho.reduce((acc, i) => acc + i.venda*i.qty, 0);
        const metodo = document.getElementById('pag-metodo').value || 'Dinheiro';
        setLoading(btn, true);
        const batch = isDemoMode ? MockDB : db.batch();
        
        carrinho.forEach(i => batch.update(getUserRef("produtos").doc(i.id), { qtd: i.qtd - i.qty })); 
        
        const desc = `Venda PDV - ${metodo}`;
        batch.set(getUserRef("financas").doc(), { tipo: 'entrada', desc, metodo, valor: total, dataISO: new Date().toISOString() });
        
        if(!isDemoMode) await batch.commit();
        setLoading(btn, false); limparCarrinho(); bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
        Swal.fire('Sucesso', 'Venda realizada!', 'success'); atualizarDashboard();
    }

    function renderListasSimples() {
        document.getElementById('lista-financa').innerHTML = financas.slice(0,10).map(f => `<tr><td class="ps-4"><span class="badge ${f.tipo==='entrada'?'bg-success':'bg-danger'}">${f.tipo}</span></td><td>${esc(f.desc)}</td><td>${formatCurrency(f.valor)}</td><td class="text-end pe-4"><button onclick="del('financas','${f.id}')" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        document.getElementById('lista-estoque').innerHTML = produtos.map(p => `<tr><td class="ps-4">${esc(p.nome)}</td><td>${p.qtd}</td><td>${formatCurrency(p.venda)}</td><td class="text-end pe-4"><button onclick="del('produtos','${p.id}')" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button></td></tr>`).join('');
    }

    function abrirModalFinanca(){ new bootstrap.Modal(document.getElementById('modalFinanca')).show(); }
    function abrirModalProduto(){ new bootstrap.Modal(document.getElementById('modalProduto')).show(); }
    function abrirModalNovoFiado(){ new bootstrap.Modal(document.getElementById('modalNovoFiado')).show(); }
    
    async function salvarFinanca(btn) { 
        const d={tipo:document.getElementById('fin-tipo').value, desc:document.getElementById('fin-desc').value, valor:parseFloat(document.getElementById('fin-valor').value), dataISO:new Date().toISOString()};
        if(!d.desc || !d.valor) return;
        setLoading(btn,true); await getUserRef("financas").add(d); setLoading(btn,false); bootstrap.Modal.getInstance(document.getElementById('modalFinanca')).hide();
    }
    async function salvarProduto(btn) {
        const d={nome:document.getElementById('prod-nome').value, qtd:parseInt(document.getElementById('prod-qtd').value), custo:parseFloat(document.getElementById('prod-custo').value), venda:parseFloat(document.getElementById('prod-venda').value), min:5};
        setLoading(btn,true); await getUserRef("produtos").add(d); setLoading(btn,false); bootstrap.Modal.getInstance(document.getElementById('modalProduto')).hide();
    }
    async function criarNovoFiado(btn) {
        const d={cliente:document.getElementById('novo-fiado-nome').value, valorRestante:parseFloat(document.getElementById('novo-fiado-valor').value)};
        setLoading(btn,true); await getUserRef("fiados").add(d); setLoading(btn,false); bootstrap.Modal.getInstance(document.getElementById('modalNovoFiado')).hide();
    }
    function del(col, id) { getUserRef(col).doc(id).delete(); }

    function tentarLogin(btn) { 
        setLoading(btn, true);
        auth.signInWithEmailAndPassword(document.getElementById('email-login').value, document.getElementById('senha-login').value)
            .catch(e => { Swal.fire('Erro', e.message, 'error'); setLoading(btn, false); });
    }
    function fazerLogout() { auth.signOut(); location.reload(); }
</script>
</body>
</html>
