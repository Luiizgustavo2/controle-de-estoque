<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Nexus ERP v28.1 - Premium Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { 
            /* Paleta Elegant Corporate */
            --primary-color: #6366f1; /* Indigo vibrante */
            --primary-hover: #4f46e5;
            --secondary-color: #64748b; /* Slate text */
            
            --bg-body: #f1f5f9; /* Slate 100 - Mais suave que branco */
            --sidebar-bg: #0f172a; /* Slate 900 - Profundo e elegante */
            --surface: #ffffff;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            
            --shadow-subtle: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --shadow-glow: 0 0 15px rgba(99, 102, 241, 0.15);
            
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-body); 
            color: #334155; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased;
        }
        
        /* SCROLLBAR MODERNA */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* SIDEBAR PREMIUM */
        .sidebar { 
            position: fixed; top: 0; left: 0; bottom: 0;
            width: 270px; 
            background: var(--sidebar-bg); 
            color: #94a3b8; 
            z-index: 1000; 
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        
        .sidebar-brand {
            padding: 30px 25px;
            color: white;
            font-weight: 800;
            letter-spacing: -0.5px;
            display: flex; align-items: center; gap: 12px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.03), transparent);
        }
        .sidebar-brand i { color: var(--primary-color); filter: drop-shadow(0 0 8px rgba(99,102,241,0.5)); }

        .sidebar-menu { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.1); }

        .nav-link { 
            color: #94a3b8; 
            margin: 4px 0; 
            border-radius: var(--radius-sm); 
            padding: 12px 15px; 
            display: flex; align-items: center; 
            font-weight: 500; 
            font-size: 0.95rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .nav-link i { width: 24px; text-align: center; margin-right: 12px; font-size: 1.1em; transition: 0.2s; }
        
        .nav-link:hover { color: white; background: rgba(255,255,255,0.04); padding-left: 20px; }
        .nav-link.active { 
            color: white; 
            background: var(--primary-color); 
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            font-weight: 600;
        }
        .nav-link.active i { transform: scale(1.1); }

        /* MAIN CONTENT */
        main { margin-left: 270px; padding: 40px; min-height: 100vh; transition: 0.3s; }
        
        /* CARDS & UI ELEMENTS */
        .card-custom { 
            border: none; 
            border-radius: var(--radius-lg); 
            background: var(--surface); 
            box-shadow: var(--shadow-subtle); 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        .card-active { cursor: pointer; }
        .card-active:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow-float); 
        }
        .card-active:active { transform: scale(0.98); }

        /* √çcones Dashboard - Estilo "Soft" */
        .icon-box { 
            width: 50px; height: 50px; 
            border-radius: 14px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.3rem; 
            margin-bottom: 15px;
        }
        .bg-green-soft { background-color: #ecfdf5; color: var(--success); }
        .bg-red-soft { background-color: #fef2f2; color: var(--danger); }
        .bg-blue-soft { background-color: #eff6ff; color: var(--info); }
        .bg-orange-soft { background-color: #fff7ed; color: var(--warning); }
        
        /* TYPOGRAPHY */
        h1, h2, h3, h4, h5, h6 { color: #1e293b; font-weight: 700; letter-spacing: -0.02em; }
        .text-muted { color: #64748b !important; }
        
        /* INPUTS MODERNOS */
        .form-control, .form-select {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: var(--radius-md);
            padding: 12px 15px;
            font-size: 0.95rem;
            transition: 0.2s;
        }
        .form-control:focus, .form-select:focus {
            background-color: white;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* BUTTONS */
        .btn { border-radius: 50px; padding: 10px 24px; font-weight: 600; letter-spacing: 0.3px; transition: 0.2s; border: none; }
        .btn-primary { background: var(--primary-color); box-shadow: 0 4px 6px rgba(99, 102, 241, 0.25); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 6px 12px rgba(99, 102, 241, 0.3); }
        .btn-success { background: var(--success); box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25); }
        .btn-light { background: white; border: 1px solid #e2e8f0; color: #475569; }
        .btn-light:hover { background: #f8fafc; color: #1e293b; border-color: #cbd5e1; }

        /* TABLES */
        .table { --bs-table-bg: transparent; }
        .table thead th { 
            background-color: #f8fafc; 
            color: #64748b; 
            font-weight: 600; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 10px;
        }
        .table td { padding: 15px 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .table-hover tbody tr:hover { background-color: #f8fafc; }

        /* MODAL GLASSMORPHISM */
        .modal-content {
            border: none;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .modal-backdrop.show { opacity: 0.3; backdrop-filter: blur(4px); }
        
        /* CHAT IA */
        .chat-container { background: #ffffff; border: 1px solid #f1f5f9; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .chat-user { background: var(--primary-color); border-radius: 18px 18px 2px 18px; box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2); }
        .chat-bot { background: #f1f5f9; color: #334155; border: none; border-radius: 18px 18px 18px 2px; }

        /* PDV ITEMS */
        .pdv-product-card { 
            border: 1px solid #f1f5f9; 
            background: white;
            transition: 0.2s;
        }
        .pdv-product-card:hover { border-color: var(--primary-color); background: #fdfdff; }
        .cart-area { position: sticky; top: 20px; height: calc(100vh - 80px); display: flex; flex-direction: column; background: white; }

        /* MOBILE */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; }
            .sidebar.show { transform: translateX(0); }
            main { margin-left: 0; padding: 20px; padding-top: 80px !important; }
            .mobile-header { display: flex !important; justify-content: space-between; padding: 15px 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); color: #0f172a; align-items: center; position: fixed; top:0; left:0; width:100%; z-index:900; border-bottom: 1px solid #e2e8f0; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 999; backdrop-filter: blur(4px); }
            .overlay.show { display: block; }
        }
        .mobile-header { display: none; }
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* LOGIN */
        #login-screen { background: #0f172a; background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 20%); }
        .login-box { border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }

        /* Utilit√°rios */
        .shadow-glow { box-shadow: var(--shadow-glow); }
        .text-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>

<div id="global-loader" class="hide"><div class="text-center"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem; border-width: 3px;"></div><p class="mt-3 fw-bold text-muted small letter-spacing-2 blink">CARREGANDO NEXUS</p></div></div>

<div id="login-screen">
    <div class="login-box fade-in p-5">
        <div class="mb-5">
            <div class="bg-primary bg-opacity-10 d-inline-flex p-3 rounded-4 mb-3"><i class="fas fa-layer-group fa-3x text-primary"></i></div>
            <h2 class="fw-bold mb-0">Nexus <span class="text-primary">Cloud</span></h2>
            <p class="text-muted small">Intelig√™ncia Financeira</p>
        </div>
        <input type="email" id="email-login" class="form-control form-control-lg mb-3" placeholder="Seu e-mail">
        <input type="password" id="senha-login" class="form-control form-control-lg mb-4" placeholder="Sua senha">
        <div class="d-grid gap-3">
            <button onclick="tentarLogin(this)" class="btn btn-primary btn-lg">Acessar Sistema</button>
            <button onclick="tentarCriarConta(this)" class="btn btn-light btn-lg">Criar Conta</button>
            <div class="text-center mt-2">
                 <a href="#" onclick="entrarModoDemo(this)" class="text-decoration-none small text-muted fw-bold"><i class="fas fa-flask me-1"></i> Entrar em Modo Demonstra√ß√£o</a>
            </div>
        </div>
        <small class="text-muted mt-4 d-block" id="status-login"></small>
    </div>
</div>

<div id="area-impressao" class="hide"></div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>
<div class="mobile-header">
    <div class="fw-bold fs-4 d-flex align-items-center gap-2"><i class="fas fa-layer-group text-primary"></i> NEXUS</div>
    <button class="btn btn-light border-0" onclick="toggleMenu()"><i class="fas fa-bars fa-lg"></i></button>
</div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
        <i class="fas fa-layer-group fa-2x"></i>
        <div>
            <div class="fs-5">NEXUS</div>
            <div style="font-size: 0.65rem; color: var(--primary-color); text-transform: uppercase; letter-spacing: 1px;">Enterprise</div>
        </div>
    </div>
    
    <div class="px-4 mb-4 mt-2">
        <div class="p-3 rounded-3" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);">
            <div class="d-flex align-items-center gap-2 mb-1">
                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 5px #10b981;"></div>
                <small class="text-white fw-bold" style="font-size: 0.75rem;">ONLINE</small>
            </div>
            <small class="text-secondary text-truncate d-block" id="user-display">Carregando...</small>
        </div>
    </div>

    <div class="sidebar-menu">
        <small class="text-uppercase fw-bold text-muted px-3 mb-2 d-block" style="font-size: 0.7rem; letter-spacing: 1px;">Menu Principal</small>
        <ul class="nav flex-column gap-1">
            <li class="nav-item"><a class="nav-link active" onclick="navTo('dashboard')"><i class="fas fa-home"></i> Vis√£o Geral</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('ia-agent')"><i class="fas fa-microchip"></i> Nexus AI <span class="badge bg-primary bg-opacity-25 text-primary ms-auto rounded-pill" style="font-size: 0.6em;">BETA</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('pdv')"><i class="fas fa-cash-register"></i> Ponto de Venda</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('fiados')"><i class="fas fa-users"></i> Clientes & Fiados <span class="badge bg-danger ms-auto rounded-pill" style="font-size: 0.6em;" id="badge-fiados">0</span></a></li>
            
            <small class="text-uppercase fw-bold text-muted px-3 mt-4 mb-2 d-block" style="font-size: 0.7rem; letter-spacing: 1px;">Gest√£o</small>
            
            <li class="nav-item"><a class="nav-link" onclick="navTo('contas')"><i class="fas fa-file-invoice"></i> Contas a Pagar</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('estoque')"><i class="fas fa-boxes"></i> Estoque</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('financeiro')"><i class="fas fa-chart-pie"></i> Financeiro</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('relatorios')"><i class="fas fa-print"></i> Relat√≥rios</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('os')"><i class="fas fa-tools"></i> Ordens de Servi√ßo</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('config')"><i class="fas fa-sliders-h"></i> Configura√ß√µes</a></li>
        </ul>
    </div>
    <div class="sidebar-footer">
        <button class="btn btn-outline-danger w-100 btn-sm rounded-pill fw-bold" onclick="fazerLogout()"><i class="fas fa-sign-out-alt me-2"></i> Encerrar Sess√£o</button>
    </div>
</nav>

<main>
    <div class="container-fluid p-0" id="app-content" style="filter: blur(5px);">
        
        <div id="dashboard" class="section fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold mb-1">Vis√£o Geral</h3>
                    <p class="text-muted m-0 small">Resumo financeiro em tempo real</p>
                </div>
                <div class="d-none d-md-block text-end">
                    <span class="badge bg-white text-secondary border px-3 py-2 rounded-pill"><i class="far fa-calendar me-2"></i> Hoje: <span id="data-hoje-topo"></span></span>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="card card-custom card-active p-4 h-100 border-start border-4 border-success">
                        <div class="d-flex justify-content-between mb-3">
                            <div class="icon-box bg-green-soft rounded-circle"><i class="fas fa-arrow-up"></i></div>
                            <span class="badge bg-green-soft rounded-pill px-3 py-2 h-auto align-self-start">+ Entradas</span>
                        </div>
                        <h2 class="fw-bold mb-0 text-dark" id="dash-entradas">R$ 0,00</h2>
                        <small class="text-muted mt-2 d-block">Receita acumulada no m√™s</small>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="card card-custom card-active p-4 h-100 border-start border-4 border-danger">
                        <div class="d-flex justify-content-between mb-3">
                            <div class="icon-box bg-red-soft rounded-circle"><i class="fas fa-arrow-down"></i></div>
                            <span class="badge bg-red-soft rounded-pill px-3 py-2 h-auto align-self-start">- Sa√≠das</span>
                        </div>
                        <h2 class="fw-bold mb-0 text-dark" id="dash-saidas">R$ 0,00</h2>
                        <small class="text-muted mt-2 d-block">Despesas acumuladas no m√™s</small>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="card card-custom card-active p-4 h-100 border-start border-4 border-primary">
                        <div class="d-flex justify-content-between mb-3">
                            <div class="icon-box bg-blue-soft rounded-circle"><i class="fas fa-wallet"></i></div>
                            <span class="badge bg-blue-soft rounded-pill px-3 py-2 h-auto align-self-start">Saldo</span>
                        </div>
                        <h2 class="fw-bold mb-0 text-primary" id="dash-saldo">R$ 0,00</h2>
                        <small class="text-muted mt-2 d-block">Fluxo de caixa atual</small>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="card card-custom card-active p-4 h-100 border-start border-4 border-warning">
                        <div class="d-flex justify-content-between mb-3">
                            <div class="icon-box bg-orange-soft rounded-circle"><i class="fas fa-hand-holding-usd"></i></div>
                            <span class="badge bg-orange-soft rounded-pill px-3 py-2 h-auto align-self-start">A Receber</span>
                        </div>
                        <h2 class="fw-bold mb-0 text-warning" id="dash-total-fiado">R$ 0,00</h2>
                        <small class="text-muted mt-2 d-block">Total pendente em fiados</small>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="card card-custom h-100">
                        <div class="card-header bg-white border-bottom p-4">
                            <h6 class="fw-bold m-0"><i class="fas fa-bell text-warning me-2"></i>Central de Avisos</h6>
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush" id="lista-alertas">
                                <li class="list-group-item text-muted text-center py-5 border-0">
                                    <i class="fas fa-check-circle fa-2x mb-3 text-success opacity-50"></i><br>
                                    Tudo em ordem por aqui!
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card card-custom h-100">
                        <div class="card-header bg-white border-bottom p-4 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0">√öltimas Movimenta√ß√µes</h6>
                            <button class="btn btn-sm btn-light rounded-pill" onclick="navTo('financeiro')">Ver Tudo</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <tbody id="dash-ultimas-movimentacoes"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="ia-agent" class="section hide">
            <div class="row h-100 justify-content-center">
                <div class="col-lg-8">
                    <div class="card card-custom h-100 border-0 shadow-lg">
                        <div class="card-header bg-white p-4 border-bottom d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary text-white rounded-circle p-3 me-3 shadow-glow"><i class="fas fa-robot fa-lg"></i></div>
                                <div>
                                    <h5 class="fw-bold m-0">Nexus Brain</h5>
                                    <small class="text-muted">Assistente Inteligente</small>
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-light rounded-pill px-3 fw-bold small dropdown-toggle" type="button" data-bs-toggle="dropdown">MODO COMANDO</button>
                                <ul class="dropdown-menu shadow border-0 rounded-4 p-2">
                                    <li><a class="dropdown-item rounded-3 mb-1" href="#" onclick="setIAMode('comando')">üöÄ Executar Comandos</a></li>
                                    <li><a class="dropdown-item rounded-3 mb-1" href="#" onclick="setIAMode('admin')">üìä Consultar Dados</a></li>
                                    <li><a class="dropdown-item rounded-3" href="#" onclick="setIAMode('cliente')">üí¨ Simulador de Atendimento</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body bg-light p-0">
                            <div id="chat-output" class="chat-container p-4" style="height: 500px; overflow-y: auto;"></div>
                        </div>
                        <div class="card-footer bg-white p-4">
                            <div class="d-flex gap-3 align-items-center">
                                <button class="btn btn-light rounded-circle shadow-sm" style="width: 50px; height: 50px;" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                                <div class="input-group bg-light rounded-pill p-1 border">
                                    <input type="text" id="chat-input" class="form-control border-0 bg-transparent shadow-none ps-4" placeholder="Digite 'Vendi 2 cocas'..." onkeypress="if(event.key==='Enter') enviarMsgIA()">
                                    <button class="btn btn-primary rounded-pill px-4 m-1" onclick="enviarMsgIA()"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                            <div id="ia-whatsapp-actions" class="mt-2 text-end hide"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pdv" class="section hide">
            <div class="row g-4 h-100">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold m-0">Caixa</h3>
                        <div class="position-relative w-50">
                            <input type="text" id="pdv-search" class="form-control rounded-pill ps-5 py-2 shadow-sm border-0" placeholder="Buscar produto..." onkeyup="renderPDVGrid()">
                            <i class="fas fa-search position-absolute text-muted" style="left: 20px; top: 12px;"></i>
                        </div>
                    </div>
                    <div class="row g-3" id="pdv-grid"></div>
                </div>
                <div class="col-lg-4">
                    <div class="card card-custom cart-area shadow-lg border-0 h-100">
                        <div class="p-4 border-bottom bg-light d-flex justify-content-between align-items-center rounded-top-4">
                            <h5 class="fw-bold m-0"><i class="fas fa-shopping-basket me-2 text-primary"></i>Carrinho</h5>
                            <button class="btn btn-sm btn-white text-danger border rounded-pill px-3" onclick="limparCarrinho()"><i class="fas fa-trash me-2"></i>Limpar</button>
                        </div>
                        <div class="cart-items p-3 flex-grow-1 overflow-auto" id="pdv-cart-items"></div>
                        <div class="p-4 bg-white border-top">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="small fw-bold text-muted text-uppercase">Desconto</label>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary toggle-desc active" id="btn-desc-money" onclick="toggleDescTipo('money')">R$</button>
                                        <button class="btn btn-outline-secondary toggle-desc" id="btn-desc-percent" onclick="toggleDescTipo('percent')">%</button>
                                    </div>
                                </div>
                                <input type="number" id="pdv-desconto" class="form-control text-end fw-bold" value="0" min="0" oninput="renderCart()">
                            </div>
                            <div class="d-flex justify-content-between align-items-end mb-4">
                                <span class="text-muted small">Total a Pagar</span>
                                <span id="pdv-total" class="h2 fw-bold text-primary m-0">R$ 0,00</span>
                            </div>
                            <button class="btn btn-primary w-100 btn-lg shadow-lg" onclick="abrirModalPagamento()">FINALIZAR VENDA <i class="fas fa-arrow-right ms-2"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fiados" class="section hide">
            <div class="card card-custom p-4 mb-4">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <div>
                        <h3 class="fw-bold mb-1">Clientes & Fiados</h3>
                        <p class="text-muted m-0 small">Gerencie d√©bitos e cr√©ditos dos clientes</p>
                    </div>
                    <div class="d-flex gap-2">
                        <input type="text" id="busca-cliente" class="form-control rounded-pill" placeholder="üîç Buscar cliente..." onkeyup="renderFiados()">
                        <button class="btn btn-primary rounded-pill px-4 text-nowrap" onclick="abrirModalNovoFiado()"><i class="fas fa-plus me-2"></i>Novo Cliente</button>
                    </div>
                </div>
            </div>
            <div class="card card-custom p-0 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead><tr><th class="ps-4">Cliente</th><th>Contato</th><th>Status Financeiro</th><th>Cr√©dito em Loja</th><th class="text-end pe-4">A√ß√µes</th></tr></thead>
                        <tbody id="lista-fiados"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="contas" class="section hide">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Contas a Pagar</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-white border rounded-pill shadow-sm" onclick="abrirModalOCR('contas')"><i class="fas fa-camera me-2 text-primary"></i>Ler Boleto</button>
                    <button class="btn btn-primary rounded-pill shadow-sm px-4" onclick="abrirModalConta()"><i class="fas fa-plus me-2"></i>Adicionar</button>
                </div>
            </div>
            <div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th class="ps-4">Vencimento</th><th>Descri√ß√£o</th><th>Valor</th><th>Status</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-contas"></tbody></table></div></div>
        </div>

        <div id="estoque" class="section hide">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Controle de Estoque</h3>
                <div class="d-flex gap-2">
                    <input type="text" id="busca-estoque" class="form-control rounded-pill" placeholder="Buscar produto..." onkeyup="renderEstoque()">
                    <button class="btn btn-primary rounded-pill px-4" onclick="abrirModalProduto()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th class="ps-4">Produto</th><th>Qtd</th><th>Custo</th><th>Venda</th><th>Margem</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-estoque"></tbody></table></div></div>
        </div>

        <div id="financeiro" class="section hide">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Movimenta√ß√µes Financeiras</h3>
                <div class="d-flex gap-2">
                    <input type="text" id="busca-financa" class="form-control rounded-pill" placeholder="Filtrar..." onkeyup="renderFinancas()">
                    <button class="btn btn-primary rounded-pill px-4" onclick="abrirModalFinanca()"><i class="fas fa-plus me-2"></i>Lan√ßar</button>
                </div>
            </div>
            <div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th class="ps-4">Tipo</th><th>Descri√ß√£o</th><th>Valor</th><th>Data</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-financa"></tbody></table></div></div>
        </div>

        <div id="relatorios" class="section hide">
            <h3 class="fw-bold mb-4">Relat√≥rios de Performance</h3>
            <div class="row g-4 mb-4">
                <div class="col-md-3"><div class="card card-custom p-4 bg-success text-white border-0"><h6 class="opacity-75 mb-1">Receita Total</h6><h3 class="fw-bold m-0" id="rel-receita">R$ 0,00</h3></div></div>
                <div class="col-md-3"><div class="card card-custom p-4 bg-danger text-white border-0"><h6 class="opacity-75 mb-1">Despesas</h6><h3 class="fw-bold m-0" id="rel-despesa">R$ 0,00</h3></div></div>
                <div class="col-md-3"><div class="card card-custom p-4 bg-primary text-white border-0"><h6 class="opacity-75 mb-1">Lucro L√≠quido</h6><h3 class="fw-bold m-0" id="rel-lucro">R$ 0,00</h3></div></div>
                <div class="col-md-3"><div class="card card-custom p-4 text-white border-0" style="background: #8b5cf6;"><h6 class="opacity-75 mb-1">Margem M√©dia</h6><h3 class="fw-bold m-0" id="rel-margem">0%</h3></div></div>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-md-8"><div class="card card-custom p-4"><h6 class="fw-bold mb-4">Fluxo de Caixa (7 dias)</h6><div style="height: 300px;"><canvas id="graficoFinanceiro"></canvas></div></div></div>
                <div class="col-md-4"><div class="card card-custom p-4"><h6 class="fw-bold mb-4">Meios de Pagamento</h6><div style="height: 300px;"><canvas id="graficoMetodos"></canvas></div></div></div>
            </div>
        </div>

        <div id="os" class="section hide">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Ordens de Servi√ßo</h3>
                <button class="btn btn-primary rounded-pill px-4 shadow-sm" onclick="abrirModalOS()"><i class="fas fa-plus me-2"></i> Nova O.S.</button>
            </div>
            <div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th class="ps-4">Cliente</th><th>Servi√ßo/Defeito</th><th>Prazo</th><th>Valor</th><th>Status</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-os"></tbody></table></div></div>
        </div>

        <div id="config" class="section hide">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card card-custom p-5">
                        <h4 class="fw-bold mb-4">Configura√ß√µes do Sistema</h4>
                        <div class="mb-4">
                            <label class="form-label text-muted small fw-bold text-uppercase">Dados da Loja</label>
                            <input type="text" id="conf-nome" class="form-control mb-2" placeholder="Nome Fantasia">
                            <input type="text" id="conf-cnpj" class="form-control mb-2" placeholder="CNPJ">
                            <input type="text" id="conf-end" class="form-control mb-2" placeholder="Endere√ßo Completo">
                            <input type="text" id="conf-msg" class="form-control" placeholder="Mensagem do Rodap√© do Cupom">
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-muted small fw-bold text-uppercase">Intelig√™ncia Artificial (Google Gemini)</label>
                            <input type="password" id="conf-apikey" class="form-control" placeholder="Cole sua API Key aqui">
                            <div class="form-text text-muted">Deixe em branco para usar apenas comandos nativos.</div>
                        </div>
                        <button class="btn btn-success w-100 mb-4" onclick="salvarConfig(this)">Salvar Altera√ß√µes</button>
                        <hr>
                        <h6 class="text-danger fw-bold mt-4 mb-3">Zona de Perigo</h6>
                        <button class="btn btn-outline-danger w-100" onclick="resetarSistema()"><i class="fas fa-trash-alt me-2"></i> Resetar F√°brica (Apagar Tudo)</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<div class="modal fade" id="modalPagamento" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="fw-bold ms-2">Finalizar Venda</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="text-center mb-4"><small class="text-muted text-uppercase fw-bold">Valor Total</small><h1 class="fw-bold display-4 text-primary" id="modal-pag-total">R$ 0,00</h1></div><div class="mb-4"><label class="form-label small text-muted fw-bold">CLIENTE (Opcional)</label><input type="text" id="cliente-pdv" class="form-control text-center fw-bold" placeholder="Nome do Cliente" onblur="verificarCreditoCliente()"><div id="aviso-credito" class="text-center mt-2 small text-success fw-bold hide"></div><input type="text" id="cliente-zap" class="form-control text-center mt-2" placeholder="WhatsApp (Somente N√∫meros)"></div><p class="fw-bold mb-3 text-muted small">FORMA DE PAGAMENTO</p><input type="hidden" id="pag-metodo" value=""><div class="row g-3 mb-4"><div class="col-4"><button class="btn btn-light w-100 py-3 btn-pagamento border" onclick="selectPagamento('Dinheiro', this)"><i class="fas fa-money-bill-wave text-success mb-2 d-block fa-lg"></i>Dinheiro</button></div><div class="col-4"><button class="btn btn-light w-100 py-3 btn-pagamento border" onclick="selectPagamento('PIX', this)"><i class="fas fa-qrcode text-info mb-2 d-block fa-lg"></i>PIX</button></div><div class="col-4"><button class="btn btn-light w-100 py-3 btn-pagamento border" onclick="selectPagamento('Cart√£o', this)"><i class="fas fa-credit-card text-primary mb-2 d-block fa-lg"></i>Cart√£o</button></div><div class="col-12"><button class="btn btn-light w-100 py-3 btn-pagamento border-danger text-danger" onclick="selectPagamento('Fiado', this)"><i class="fas fa-hand-holding-usd mb-2 d-block fa-lg"></i>Fiado / Pendente</button></div></div><button class="btn btn-success w-100 btn-lg shadow-lg" onclick="processarVenda(this)">CONFIRMAR VENDA</button></div></div></div></div>

<div class="modal fade" id="modalPagarFiado" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4 text-center"><h5 class="fw-bold mb-4">Receber Valor</h5><input type="hidden" id="fiado-id"><h2 class="text-danger fw-bold mb-4" id="fiado-valor-total">R$ 0,00</h2><input type="number" id="fiado-valor-pagar" class="form-control form-control-lg mb-4 text-center fw-bold" placeholder="R$ 0,00"><button class="btn btn-success w-100 btn-lg" onclick="confirmarRecebimentoFiado(this)">Confirmar Recebimento</button></div></div></div></div>
<div class="modal fade" id="modalNovoFiado" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Novo Cliente</h5><input type="text" id="novo-fiado-nome" class="form-control mb-3" placeholder="Nome Completo"><input type="text" id="novo-fiado-zap" class="form-control mb-3" placeholder="WhatsApp"><div class="form-floating mb-3"><input type="number" id="novo-fiado-valor" class="form-control" value="0"><label>Saldo Devedor Inicial</label></div><button class="btn btn-primary w-100" onclick="criarNovoFiado(this)">Salvar Cliente</button></div></div></div></div>
<div class="modal fade" id="modalOCR" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4 text-center"><input type="hidden" id="ocr-origem" value="contas"><h5 class="fw-bold mb-3">Leitor Inteligente</h5><div class="border border-2 border-dashed p-5 mb-3 rounded bg-light"><i class="fas fa-camera fa-3x text-muted mb-3"></i><p class="text-muted small">Clique para tirar foto ou enviar arquivo</p><input type="file" id="ocr-file" class="form-control opacity-0 position-absolute" style="margin-top:-80px;" accept="image/*" onchange="processarImagemOCR(this)"></div><div id="ocr-progress" class="hide mb-3"><div class="progress" style="height: 5px;"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div></div><small class="text-muted mt-2 d-block">Processando imagem...</small></div><div id="ocr-result" class="hide text-start"><div class="alert alert-success small"><i class="fas fa-check-circle me-2"></i>Leitura conclu√≠da!</div></div></div></div></div></div>
<div class="modal fade" id="modalConta" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-4">Lan√ßar Conta</h5><input type="text" id="conta-desc" class="form-control mb-3" placeholder="Descri√ß√£o (Ex: Luz)"><div class="row g-3 mb-3"><div class="col-6"><input type="number" id="conta-valor" class="form-control" placeholder="Valor R$"></div><div class="col-6"><input type="text" id="conta-venc" class="form-control" placeholder="DD/MM/AAAA"></div></div><div class="form-check mb-4"><input class="form-check-input" type="checkbox" id="conta-recorrente"><label class="form-check-label" for="conta-recorrente">Despesa Mensal Fixa</label></div><button class="btn btn-primary w-100" onclick="salvarConta(this)">Agendar Pagamento</button></div></div></div></div>
<div class="modal fade" id="modalProduto" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4"><input type="hidden" id="prod-id"><h5 class="fw-bold mb-4" id="modal-prod-titulo">Produto</h5><input type="text" id="prod-nome" class="form-control mb-3" placeholder="Nome do Produto"><div class="row g-3"><div class="col-6"><label class="small text-muted fw-bold">Estoque</label><input type="number" id="prod-qtd" class="form-control" placeholder="0"></div><div class="col-6"><label class="small text-muted fw-bold">M√≠nimo</label><input type="number" id="prod-min" class="form-control" value="5"></div><div class="col-6"><label class="small text-muted fw-bold">Custo R$</label><input type="number" id="prod-custo" class="form-control" placeholder="0.00"></div><div class="col-6"><label class="small text-muted fw-bold">Venda R$</label><input type="number" id="prod-venda" class="form-control" placeholder="0.00"></div></div><button class="btn btn-primary w-100 mt-4" onclick="salvarProduto(this)">Salvar Produto</button></div></div></div></div>
<div class="modal fade" id="modalFinanca" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Movimenta√ß√£o</h5><input type="text" id="fin-desc" class="form-control mb-2" placeholder="Descri√ß√£o"><select id="fin-tipo" class="form-select mb-2"><option value="entrada">Entrada (+)</option><option value="saida">Sa√≠da (-)</option></select><input type="number" id="fin-valor" class="form-control mb-3" placeholder="Valor R$"><button class="btn btn-success w-100" onclick="salvarFinanca(this)">Registrar</button></div></div></div></div>
<div class="modal fade" id="modalOS" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Nova O.S.</h5><input type="text" id="os-cliente" class="form-control mb-2" placeholder="Nome do Cliente"><textarea id="os-desc" class="form-control mb-2" placeholder="Descri√ß√£o do Servi√ßo / Defeito" rows="3"></textarea><div class="row g-2"><div class="col-6"><input type="number" id="os-valor" class="form-control" placeholder="Valor (0 para Or√ßamento)"></div><div class="col-6"><input type="date" id="os-data" class="form-control"></div></div><button class="btn btn-primary w-100 mt-4" onclick="salvarOS(this)">Criar O.S.</button></div></div></div></div>
<div class="modal fade" id="modalEditarOS" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Editar O.S.</h5><input type="hidden" id="edit-os-id"><input type="text" id="edit-os-cliente" class="form-control mb-2" readonly><textarea id="edit-os-desc" class="form-control mb-2" rows="3"></textarea><div class="row g-2"><div class="col-6"><input type="number" id="edit-os-valor" class="form-control" placeholder="Novo Valor"></div><div class="col-6"><input type="date" id="edit-os-data" class="form-control"></div></div><button class="btn btn-success w-100 mt-4" onclick="salvarEdicaoOS(this)">Atualizar</button></div></div></div></div>
<div class="modal fade" id="modalCredito" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4 text-center"><h5 class="fw-bold mb-1" id="cred-cliente-nome">...</h5><p class="text-muted small">Gerenciar Cr√©dito</p><h2 class="text-success fw-bold mb-3" id="cred-atual">R$ 0,00</h2><input type="hidden" id="cred-id"><label class="small text-start w-100 fw-bold text-muted mb-2">Valor para Alterar</label><input type="number" id="cred-valor" class="form-control mb-3 text-center fw-bold" placeholder="0.00"><div class="d-flex gap-2"><button class="btn btn-success flex-fill" onclick="atualizarCredito(1)"><i class="fas fa-plus"></i></button><button class="btn btn-danger flex-fill" onclick="atualizarCredito(-1)"><i class="fas fa-minus"></i></button></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<script>
    document.getElementById('data-hoje-topo').innerText = new Date().toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'});

    const firebaseConfig = { apiKey: "AIzaSyBHBFj0QRebascuwJ5LxprYeuFbk7KsiYc", authDomain: "nexus-erp-6998c.firebaseapp.com", projectId: "nexus-erp-6998c", storageBucket: "nexus-erp-6998c.firebasestorage.app", messagingSenderId: "599369243365", appId: "1:599369243365:web:3363fe65f3d36c00e1d20c", measurementId: "G-7NFRRWYYJ6" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    db.enablePersistence({ synchronizeTabs: true }).catch(err => console.warn('Persist√™ncia desativada:', err.code));
    const esc = (unsafe) => { if (!unsafe) return ''; return unsafe.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); };
    const norm = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    // VARI√ÅVEIS GLOBAIS
    let currentUser = null;
    let isDemoMode = false;
    let produtos=[], financas=[], osList=[], historico=[], carrinho=[], fiados=[], contas=[];
    let configEmpresa = { nome: 'NEXUS ERP', cnpj: '', end: '', tel: '', msg: 'Volte Sempre!', apikey: '' };
    let iaMode = 'comando', iaContext = null;
    let recognition;
    let descTipo = 'money';
    let chartFin = null, chartMet = null;

    // MOCK DB (Mantido igual)
    const MockDB = {
        collection: (col) => ({
            doc: (id) => {
                const docId = id || 'demo_'+Date.now();
                return {
                    id: docId,
                    set: async (data) => { if(col==='financas') financas.unshift({...data, id:docId}); if(col==='historico') historico.unshift({...data, id:docId}); if(col==='os') osList.push({...data, id:docId}); atualizarDashboard(); },
                    update: async (data) => { 
                        if(col==='os') { const idx = osList.findIndex(x=>x.id===id); if(idx>=0) osList[idx] = {...osList[idx], ...data}; }
                        if(col==='produtos') { const idx = produtos.findIndex(x=>x.id===id); if(idx>=0) produtos[idx] = {...produtos[idx], ...data}; }
                        if(col==='fiados') { const idx = fiados.findIndex(x=>x.id===id); if(idx>=0) fiados[idx] = {...fiados[idx], ...data}; }
                        atualizarDashboard(); 
                    },
                    delete: async () => { 
                        if(col==='os') osList = osList.filter(x=>x.id!==id);
                        if(col==='financas') financas = financas.filter(x=>x.id!==id);
                        if(col==='produtos') produtos = produtos.filter(x=>x.id!==id);
                        if(col==='contas') contas = contas.filter(x=>x.id!==id);
                        atualizarDashboard(); renderOS(); renderFinancas(); renderEstoque(); renderContas();
                    },
                    get: async () => ({ data: () => {
                         if(col==='fiados') return fiados.find(f=>f.id===id);
                         return {};
                    } })
                }
            },
            add: async (data) => { 
                const newId = 'demo_'+Date.now(); 
                if(col==='historico') historico.unshift({...data, id:newId});
                if(col==='financas') financas.unshift({...data, id:newId});
                if(col==='os') { osList.push({...data, id:newId}); renderOS(); }
                if(col==='contas') { contas.push({...data, id:newId}); renderContas(); }
                if(col==='produtos') { produtos.push({...data, id:newId}); renderEstoque(); }
                if(col==='fiados') { fiados.push({...data, id:newId}); renderFiados(); }
                atualizarDashboard();
                return { id: newId };
            },
            orderBy: () => ({ limit: () => ({ onSnapshot: () => {} }) }),
            onSnapshot: () => {} 
        })
    };

    function getUserRef(c) { 
        if (isDemoMode) return MockDB.collection(c);
        return currentUser ? db.collection("users").doc(currentUser.uid).collection(c) : null; 
    }
    
    function getConfigRef() { 
        if (isDemoMode) return { set: async (d) => { configEmpresa = d; }, onSnapshot: (cb) => cb({exists:true, data:()=>configEmpresa}) };
        return currentUser ? db.collection("users").doc(currentUser.uid).collection("config").doc("geral") : null; 
    }

    function setLoading(btn, isLoading) { if(isLoading) { btn.disabled=true; btn.orig=btn.innerHTML; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>'; } else { btn.disabled=false; btn.innerHTML=btn.orig; } }

    function tentarLogin(btn) { setLoading(btn,true); auth.signInWithEmailAndPassword(document.getElementById('email-login').value, document.getElementById('senha-login').value).catch(e=>{Swal.fire('Erro',e.message,'error'); setLoading(btn,false)}); }
    function tentarCriarConta(btn) { setLoading(btn,true); auth.createUserWithEmailAndPassword(document.getElementById('email-login').value, document.getElementById('senha-login').value).then(()=>{Swal.fire('Sucesso','','success')}).catch(e=>{Swal.fire('Erro',e.message,'error'); setLoading(btn,false)}); }
    function fazerLogout() { auth.signOut(); location.reload(); }

    function entrarModoDemo(btn) {
        setLoading(btn, true);
        setTimeout(() => {
            isDemoMode = true;
            currentUser = { uid: 'demo_user', email: 'demo@nexus.ai' };
            document.getElementById('login-screen').classList.add('hide');
            document.getElementById('app-content').style.filter='none';
            document.getElementById('user-display').innerText = "MODO DEMONSTRA√á√ÉO";
            
            produtos = [
                {id:'1', nome:'Coca Cola 2L', qtd:50, custo:6.00, venda:10.00, min:10},
                {id:'2', nome:'Cabo USB-C', qtd:20, custo:5.00, venda:25.00, min:5},
                {id:'3', nome:'Fone Bluetooth', qtd:3, custo:40.00, venda:90.00, min:5},
                {id:'4', nome:'Carregador Turbo', qtd:15, custo:15.00, venda:45.00, min:5}
            ];
            fiados = [
                {id:'1', cliente:'Jo√£o Silva', zap:'11999999999', valorRestante:50.00, saldoCredito:0},
                {id:'2', cliente:'Maria Souza', zap:'', valorRestante:0, saldoCredito:10.00}
            ];
            osList = [
                {id:'1', cliente:'Pedro Ramos', desc:'Formatar PC', valor:80.00, prazo:'2026-02-10', concluido:false, dataCriacao: new Date().toISOString()},
                {id:'2', cliente:'Loja XYZ', desc:'Instalar Rede', valor:250.00, prazo:'2026-02-01', concluido:true, dataCriacao: new Date().toISOString()}
            ];
            financas = [
                {id:'1', tipo:'entrada', desc:'Venda Balc√£o', valor:150.00, dataISO: new Date().toISOString()},
                {id:'2', tipo:'saida', desc:'Compra Estoque', valor:50.00, dataISO: new Date().toISOString()}
            ];
            historico = [
                {id:'1', tipo:'Venda', desc:'Coca Cola', valor:10.00, data: new Date().toISOString()}
            ];

            renderEstoque(); renderPDVGrid(); renderFiados(); renderOS(); renderFinancas(); atualizarDashboard(); renderRelatorios();
            setIAMode('comando');
            Swal.fire({
                title: 'Modo Demo Ativado', 
                text: 'Dados fict√≠cios carregados. Nada ser√° salvo.', 
                icon: 'info',
                confirmButtonColor: '#6366f1'
            });
        }, 1000);
    }

    auth.onAuthStateChanged(u => {
        if(u && !isDemoMode) { currentUser=u; document.getElementById('login-screen').classList.add('hide'); document.getElementById('app-content').style.filter='none'; document.getElementById('user-display').innerText=u.email; iniciarSistema(); }
        else if (!isDemoMode) { document.getElementById('login-screen').classList.remove('hide'); document.getElementById('app-content').style.filter='blur(5px)'; }
    });

    function iniciarSistema() {
        if(!currentUser || isDemoMode) return;
        getUserRef("produtos").onSnapshot(s => { produtos = s.docs.map(d=>({id:d.id, ...d.data()})); renderEstoque(); renderPDVGrid(); atualizarDashboard(); });
        getUserRef("financas").orderBy("dataISO","desc").limit(50).onSnapshot(s => { financas = s.docs.map(d=>({id:d.id, ...d.data()})); renderFinancas(); atualizarDashboard(); if(document.getElementById('relatorios').classList.contains('hide') === false) renderRelatorios(); });
        getUserRef("historico").orderBy("data","desc").limit(20).onSnapshot(s => { historico = s.docs.map(d=>({id:d.id, ...d.data()})); atualizarDashboard(); });
        getUserRef("os").onSnapshot(s => { osList = s.docs.map(d=>({id:d.id, ...d.data()})); renderOS(); atualizarDashboard(); });
        getUserRef("fiados").onSnapshot(s => { fiados = s.docs.map(d=>({id:d.id, ...d.data()})); renderFiados(); atualizarDashboard(); });
        getUserRef("contas").onSnapshot(s => { contas = s.docs.map(d=>({id:d.id, ...d.data()})); renderContas(); atualizarDashboard(); });
        getConfigRef().onSnapshot(s => { if(s.exists) { configEmpresa = s.data(); carregarConfigUI(); } });
        setupVoiceRecognition();
        setIAMode('comando');
    }

    function atualizarDashboard() {
        let ent=0, sai=0;
        financas.forEach(f => { f.tipo==='entrada'? ent+=f.valor : sai+=f.valor });
        document.getElementById('dash-entradas').innerText = formatCurrency(ent);
        document.getElementById('dash-saidas').innerText = formatCurrency(sai);
        document.getElementById('dash-saldo').innerText = formatCurrency(ent-sai);
        
        let totalFiado = fiados.reduce((acc, f) => acc + (f.valorRestante || 0), 0);
        document.getElementById('dash-total-fiado').innerText = formatCurrency(totalFiado);
        document.getElementById('badge-fiados').innerText = fiados.filter(f=>f.valorRestante > 0).length;
        
        const listaAlertas = document.getElementById('lista-alertas');
        listaAlertas.innerHTML = '';
        let alertasCount = 0;

        produtos.filter(p => p.qtd <= (p.min || 5)).forEach(p => {
            listaAlertas.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center bg-white border-bottom py-3 alert-item-click" onclick="navTo('estoque'); document.getElementById('busca-estoque').value = '${esc(p.nome)}'; renderEstoque();"><span class="small fw-bold text-dark"><i class="fas fa-cube text-warning me-2"></i>${esc(p.nome)}</span><span class="badge bg-warning text-dark rounded-pill">Restam: ${p.qtd}</span></li>`;
            alertasCount++;
        });

        const hoje = new Date(); hoje.setHours(0,0,0,0);
        contas.forEach(c => {
            const vencParts = c.venc.includes('/') ? c.venc.split('/') : c.venc.split('-');
            const dataVenc = new Date(vencParts[0].length===4 ? c.venc : `${vencParts[2]}-${vencParts[1]}-${vencParts[0]}`);
            const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
            if(diffDias <= 3) {
                const cor = diffDias < 0 ? 'text-danger' : 'text-warning';
                const texto = diffDias < 0 ? `Venceu ${c.venc}` : (diffDias === 0 ? 'Vence HOJE' : `Vence ${c.venc}`);
                listaAlertas.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center bg-white border-bottom py-3 alert-item-click" onclick="navTo('contas')"><span class="small fw-bold text-dark"><i class="fas fa-exclamation-circle ${cor} me-2"></i>${esc(c.desc)}</span><span class="badge bg-danger rounded-pill">${texto}</span></li>`;
                alertasCount++;
            }
        });

        if(alertasCount === 0) listaAlertas.innerHTML = '<li class="list-group-item text-muted text-center py-5 border-0"><i class="fas fa-check-circle fa-2x mb-3 text-success opacity-50"></i><br>Tudo em ordem por aqui!</li>';
        
        const tb = document.getElementById('dash-ultimas-movimentacoes'); 
        tb.innerHTML = historico.slice(0,5).map(h => `<tr><td><span class="badge bg-light text-dark border">${esc(h.tipo)}</span></td><td class="small text-muted">${esc(h.desc)}</td><td class="fw-bold text-end text-dark">${formatCurrency(h.valor)}</td></tr>`).join('');
    }

    function renderPDVGrid(){ 
        const c=document.getElementById('pdv-grid'); 
        const s=norm(document.getElementById('pdv-search').value); 
        c.innerHTML = produtos.filter(p=>norm(p.nome).includes(s)).map(p => 
            `<div class="col-6 col-md-4 col-lg-4"><div class="pdv-product-card h-100 p-3 rounded-3 position-relative cursor-pointer" onclick="addCart('${p.id}')"><div class="d-flex justify-content-between mb-3"><span class="badge bg-light text-secondary border">Est: ${p.qtd}</span></div><h6 class="fw-bold mb-1 text-dark text-truncate">${esc(p.nome)}</h6><div class="h5 text-primary fw-bold mb-0">${formatCurrency(p.venda)}</div></div></div>`
        ).join('');
    }
    
    function addCart(id){ const p=produtos.find(x=>x.id===id), i=carrinho.find(c=>c.id===id); if(p.qtd<=(i?i.qty:0)) return Swal.fire({toast:true,icon:'error',title:'Estoque insuficiente',timer:1000,showConfirmButton:false}); i?i.qty++:carrinho.push({...p,qty:1}); renderCart(); }
    function setCartQty(id, val) { const i=carrinho.find(c=>c.id===id), p=produtos.find(x=>x.id===id); if(!i) return; let n = parseInt(val); if(isNaN(n) || n < 1) n = 1; if(n > p.qtd) { Swal.fire({toast:true,icon:'warning',title:'M√°ximo em estoque: '+p.qtd,timer:1000,showConfirmButton:false}); n = p.qtd; } i.qty = n; renderCart(); }
    function updateCartQty(id, d) { const i=carrinho.find(c=>c.id===id); if(i) setCartQty(id, i.qty + d); }
    function toggleDescTipo(tipo) { descTipo = tipo; document.getElementById('btn-desc-money').classList.toggle('active', tipo === 'money'); document.getElementById('btn-desc-percent').classList.toggle('active', tipo === 'percent'); renderCart(); }

    function renderCart(){ 
        const c=document.getElementById('pdv-cart-items'); 
        let sub=0; 
        c.innerHTML = carrinho.map(i => {
            sub+=i.venda*i.qty;
            return `<div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded-3"><div style="width:35%" class="text-truncate fw-bold small text-dark">${esc(i.nome)}</div><div class="d-flex align-items-center gap-1"><button class="btn btn-sm btn-white border px-2" onclick="updateCartQty('${i.id}',-1)">-</button><input type="number" class="form-control form-control-sm text-center p-0" style="width:40px;" value="${i.qty}" onchange="setCartQty('${i.id}', this.value)"><button class="btn btn-sm btn-white border px-2" onclick="updateCartQty('${i.id}',1)">+</button></div><div class="fw-bold small text-end" style="width:25%">${formatCurrency(i.venda*i.qty)}</div></div>`;
        }).join('');
        
        let descVal = parseFloat(document.getElementById('pdv-desconto').value) || 0;
        let totalDesc = descTipo === 'percent' ? sub * (descVal / 100) : descVal;
        const tot = Math.max(0, sub - totalDesc); 
        document.getElementById('pdv-total').innerText=formatCurrency(tot); 
        document.getElementById('modal-pag-total').innerText=formatCurrency(tot); 
    }
    
    function limparCarrinho(){ carrinho=[]; renderCart(); }
    
    function verificarCreditoCliente() {
        const nome = norm(document.getElementById('cliente-pdv').value);
        const cli = fiados.find(f => norm(f.cliente) === nome);
        const aviso = document.getElementById('aviso-credito');
        if (cli && cli.saldoCredito > 0) {
            aviso.innerText = `Cliente possui CR√âDITO de ${formatCurrency(cli.saldoCredito)}`;
            aviso.classList.remove('hide');
        } else {
            aviso.classList.add('hide');
        }
    }

    function abrirModalPagamento(){ if(carrinho.length) new bootstrap.Modal(document.getElementById('modalPagamento')).show(); }

    async function processarVenda(btn){ 
        const metodo = document.getElementById('pag-metodo').value; 
        if(!metodo) return Swal.fire('Erro','Selecione o m√©todo de pagamento','error');
        const clienteNome = document.getElementById('cliente-pdv').value.trim();
        const total = parseFloat(document.getElementById('pdv-total').innerText.replace('R$','').replace('.','').replace(',','.').trim());
        
        if(metodo === 'Fiado' && !clienteNome) return Swal.fire('Erro','Nome do cliente obrigat√≥rio para Fiado','error');

        setLoading(btn,true);
        const batch = isDemoMode ? MockDB : db.batch();
        const dataISO = new Date().toISOString();
        
        carrinho.forEach(i => { batch.update(getUserRef("produtos").doc(i.id), { qtd: firebase.firestore.FieldValue.increment(-i.qty) }); });

        let valorFinal = total;
        let usouCredito = 0;
        let clienteDoc = fiados.find(f => norm(f.cliente) === norm(clienteNome));
        let clienteRef = clienteDoc ? getUserRef("fiados").doc(clienteDoc.id) : getUserRef("fiados").doc();

        if (clienteDoc && clienteDoc.saldoCredito > 0) {
            if (metodo === 'Fiado') {
                if (clienteDoc.saldoCredito >= valorFinal) {
                    usouCredito = valorFinal; valorFinal = 0;
                    batch.update(clienteRef, { saldoCredito: clienteDoc.saldoCredito - usouCredito });
                } else {
                    usouCredito = clienteDoc.saldoCredito; valorFinal = valorFinal - usouCredito;
                    batch.update(clienteRef, { saldoCredito: 0 });
                }
            } else {
                if (confirm(`Usar cr√©dito de ${formatCurrency(clienteDoc.saldoCredito)}?`)) {
                    if (clienteDoc.saldoCredito >= valorFinal) {
                        usouCredito = valorFinal; valorFinal = 0;
                        batch.update(clienteRef, { saldoCredito: clienteDoc.saldoCredito - usouCredito });
                    } else {
                        usouCredito = clienteDoc.saldoCredito; valorFinal = valorFinal - usouCredito;
                        batch.update(clienteRef, { saldoCredito: 0 });
                    }
                }
            }
        }

        if(valorFinal > 0) {
            if(metodo === 'Fiado') {
                if(clienteDoc) batch.update(clienteRef, { valorRestante: (clienteDoc.valorRestante || 0) + valorFinal, ultimaAtualizacao: dataISO });
                else batch.set(clienteRef, { cliente: clienteNome, zap: document.getElementById('cliente-zap').value, valorRestante: valorFinal, saldoCredito: 0, dataCompra: dataISO, ultimaAtualizacao: dataISO });
            } else {
                batch.set(getUserRef("financas").doc(), { tipo: 'entrada', desc: `Venda PDV - ${clienteNome || 'Consumidor Final'}`, metodo: metodo, valor: valorFinal, dataISO: dataISO });
            }
        } else if (usouCredito > 0) {
             batch.set(getUserRef("financas").doc(), { tipo: 'entrada', desc: `Venda Cr√©dito - ${clienteNome}`, metodo: 'Cr√©dito Loja', valor: total, dataISO: dataISO });
        }

        let descHist = `Venda ${metodo}`;
        if(usouCredito > 0) descHist += ` (Cr√©dito ${formatCurrency(usouCredito)})`;
        batch.set(getUserRef("historico").doc(), { tipo: 'Venda', desc: descHist, valor: total, data: dataISO });

        if(!isDemoMode) await batch.commit();
        setLoading(btn,false);
        
        const dadosVendaImpressao = {
            cliente: clienteNome,
            itens: [...carrinho],
            total: total,
            subtotal: carrinho.reduce((acc, i) => acc + i.venda * i.qty, 0),
            desconto: total < carrinho.reduce((acc, i) => acc + i.venda * i.qty, 0) ? (carrinho.reduce((acc, i) => acc + i.venda * i.qty, 0) - total) : 0,
            metodo: usouCredito > 0 ? (valorFinal > 0 ? `Cr√©dito + ${metodo}` : 'Cr√©dito Loja') : metodo,
            data: new Date()
        };

        bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
        limparCarrinho();
        document.getElementById('cliente-pdv').value = '';
        document.getElementById('aviso-credito').classList.add('hide');
        
        Swal.fire({
            title: 'Venda Realizada!', text: "Deseja imprimir o cupom?", icon: 'success', showCancelButton: true, confirmButtonColor: '#6366f1', cancelButtonColor: '#ef4444', confirmButtonText: 'Sim, imprimir', cancelButtonText: 'N√£o'
        }).then((result) => { if (result.isConfirmed) imprimirCupom(dadosVendaImpressao); });
    }

    function imprimirCupom(venda) {
        let itensHtml = '';
        venda.itens.forEach(i => { itensHtml += `<div class="cupom-row"><span>${esc(i.nome).substring(0,15)}</span><span>${i.qty}x ${formatCurrency(i.venda)}</span></div>`; });
        let metodoDisplay = venda.metodo.includes('Fiado') ? 'Saldo Devedor' : venda.metodo;
        const html = `<div class="cupom-fiscal"><h4>${esc(configEmpresa.nome)}</h4><p style="text-align:center; font-size:10px;">${new Date(venda.data).toLocaleString()}</p><div class="cupom-divider"></div>${venda.cliente ? `<p>Cliente: ${esc(venda.cliente)}</p><div class="cupom-divider"></div>` : ''}${itensHtml}<div class="cupom-divider"></div><div class="cupom-row"><span>Subtotal:</span><span>${formatCurrency(venda.subtotal)}</span></div>${venda.desconto > 0 ? `<div class="cupom-row"><span>Desconto:</span><span>-${formatCurrency(venda.desconto)}</span></div>` : ''}<div class="cupom-row cupom-total"><span>TOTAL:</span><span>${formatCurrency(venda.total)}</span></div><div class="cupom-row" style="margin-top:5px;"><span>Pagamento:</span><span>${metodoDisplay}</span></div><div class="cupom-divider"></div><p style="text-align:center; font-size:10px;">${esc(configEmpresa.msg)}</p></div>`;
        imprimirConteudo(html);
    }

    function renderFiados(){
        const t = document.getElementById('lista-fiados');
        const termo = norm(document.getElementById('busca-cliente').value);
        t.innerHTML = fiados.filter(f => !termo || norm(f.cliente).includes(termo)).map(f => {
            const temDivida = f.valorRestante > 0;
            const temCredito = f.saldoCredito > 0;
            return `<tr>
                <td class="ps-4 fw-bold text-dark">${esc(f.cliente)}</td>
                <td>${f.zap ? `<a href="#" onclick="abrirZap('${f.zap}', ${f.valorRestante})" class="text-decoration-none"><i class="fab fa-whatsapp text-success me-1"></i> ${esc(f.zap)}</a>` : '-'}</td>
                <td>${temDivida ? `<span class="badge bg-danger rounded-pill">Deve: ${formatCurrency(f.valorRestante)}</span>` : '<span class="badge bg-success rounded-pill">Em dia</span>'}</td>
                <td>${temCredito ? `<span class="text-success fw-bold">${formatCurrency(f.saldoCredito)}</span>` : '-'}</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-light border me-1 rounded-pill" onclick="abrirModalCredito('${f.id}', '${esc(f.cliente)}', ${f.saldoCredito || 0})" title="Gerenciar Cr√©dito"><i class="fas fa-wallet text-secondary"></i></button>
                    ${temDivida ? `<button class="btn btn-sm btn-success rounded-pill me-1 px-3" onclick="abrirModalPagarFiado('${f.id}', ${f.valorRestante})">Receber</button>` : ''}
                    <button class="btn btn-sm btn-light text-danger border rounded-pill" onclick="del('fiados','${f.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
    }

    function abrirModalCredito(id, nome, saldo) {
        document.getElementById('cred-id').value = id;
        document.getElementById('cred-cliente-nome').innerText = nome;
        document.getElementById('cred-atual').innerText = formatCurrency(saldo);
        document.getElementById('cred-valor').value = '';
        new bootstrap.Modal(document.getElementById('modalCredito')).show();
    }

    async function atualizarCredito(fator) {
        const id = document.getElementById('cred-id').value;
        const valInput = parseFloat(document.getElementById('cred-valor').value);
        if(!valInput || valInput <= 0) return;
        
        const cliente = fiados.find(f => f.id === id);
        let novoSaldo = (cliente.saldoCredito || 0) + (valInput * fator);
        if(novoSaldo < 0) novoSaldo = 0;

        await getUserRef("fiados").doc(id).update({ saldoCredito: novoSaldo });
        
        const tipoMov = fator > 0 ? "Adi√ß√£o" : "Remo√ß√£o";
        await log("Cr√©dito", `${tipoMov} Cr√©dito - ${cliente.cliente}`, valInput);
        
        bootstrap.Modal.getInstance(document.getElementById('modalCredito')).hide();
        Swal.fire('Atualizado', `Novo saldo: ${formatCurrency(novoSaldo)}`, 'success');
    }

    function abrirZap(num, val) { if(!num) return Swal.fire('Ops','Sem n√∫mero','info'); window.open(`https://wa.me/55${num.replace(/\D/g,'')}?text=Ol√°, consta um d√©bito de ${formatCurrency(val)} na loja.`, '_blank'); }
    function abrirModalNovoFiado() { document.getElementById('novo-fiado-nome').value = ''; document.getElementById('novo-fiado-valor').value = 0; new bootstrap.Modal(document.getElementById('modalNovoFiado')).show(); }

    async function criarNovoFiado(btn) {
        const nome = document.getElementById('novo-fiado-nome').value.trim();
        const valor = parseFloat(document.getElementById('novo-fiado-valor').value) || 0;
        const zap = document.getElementById('novo-fiado-zap').value;
        if(!nome) return;
        setLoading(btn, true);
        const clienteExistente = fiados.find(f => norm(f.cliente) === norm(nome));
        if(clienteExistente) {
            const novaDivida = (clienteExistente.valorRestante || 0) + valor;
            await getUserRef("fiados").doc(clienteExistente.id).update({ valorRestante: novaDivida, zap: zap || clienteExistente.zap, ultimaAtualizacao: new Date().toISOString() });
            Swal.fire('Atualizado', `Cliente j√° existia. Saldo unificado.`, 'info');
        } else {
            await getUserRef("fiados").add({ cliente: nome, zap: zap, valorRestante: valor, saldoCredito: 0, dataCompra: new Date().toISOString(), ultimaAtualizacao: new Date().toISOString() });
            Swal.fire('Sucesso', 'Cliente cadastrado!', 'success');
        }
        setLoading(btn, false); bootstrap.Modal.getInstance(document.getElementById('modalNovoFiado')).hide();
    }

    function abrirModalPagarFiado(id, valor) { document.getElementById('fiado-id').value = id; document.getElementById('fiado-valor-total').innerText = formatCurrency(valor); document.getElementById('fiado-valor-pagar').value = valor; new bootstrap.Modal(document.getElementById('modalPagarFiado')).show(); }

    async function confirmarRecebimentoFiado(btn) { 
        const id = document.getElementById('fiado-id').value; 
        const valPago = parseFloat(document.getElementById('fiado-valor-pagar').value); 
        if(!valPago || valPago <= 0) return; 
        setLoading(btn, true); 
        
        let f;
        if(isDemoMode) { f = fiados.find(x=>x.id===id); } 
        else { const doc = await getUserRef("fiados").doc(id).get(); f = doc.data(); }

        const novaDivida = Math.max(0, f.valorRestante - valPago);
        let novoCredito = f.saldoCredito || 0;
        if (valPago > f.valorRestante) { const troco = valPago - f.valorRestante; if(confirm(`Valor pago excede a d√≠vida em ${formatCurrency(troco)}. Adicionar como cr√©dito para ${f.cliente}?`)) novoCredito += troco; }
        
        const batch = isDemoMode ? MockDB : db.batch();
        batch.update(getUserRef("fiados").doc(id), { valorRestante: novaDivida, saldoCredito: novoCredito, ultimaAtualizacao: new Date().toISOString() }); 
        batch.set(getUserRef("financas").doc(), { tipo: 'entrada', desc: `Recebimento Fiado - ${f.cliente}`, metodo: 'Dinheiro', valor: valPago, dataISO: new Date().toISOString()});
        batch.set(getUserRef("historico").doc(), { tipo: 'Recebimento', desc: `Pgto. D√≠vida ${f.cliente}`, valor: valPago, data: new Date().toISOString() });
        
        if(!isDemoMode) await batch.commit();
        setLoading(btn, false); bootstrap.Modal.getInstance(document.getElementById('modalPagarFiado')).hide(); Swal.fire('Sucesso', 'Valor recebido!', 'success'); 
    }

    function renderRelatorios() {
        let rec=0, desp=0; financas.forEach(f => f.tipo==='entrada'?rec+=f.valor:desp+=f.valor);
        document.getElementById('rel-receita').innerText = formatCurrency(rec);
        document.getElementById('rel-despesa').innerText = formatCurrency(desp);
        document.getElementById('rel-lucro').innerText = formatCurrency(rec-desp);
        document.getElementById('rel-margem').innerText = rec>0 ? ((rec-desp)/rec*100).toFixed(0)+'%' : '0%';
        document.getElementById('lista-financa').innerHTML = financas.slice(0,20).map(f => `<tr><td class="ps-4"><i class="fas ${f.tipo==='entrada'?'fa-arrow-up text-success':'fa-arrow-down text-danger'}"></i></td><td class="text-dark">${esc(f.desc)}</td><td class="fw-bold ${f.tipo==='entrada'?'text-success':'text-danger'}">${formatCurrency(f.valor)}</td><td class="text-muted small">${formatDate(f.dataISO)}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border text-danger rounded-pill" onclick="del('financas','${f.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        if(chartFin) chartFin.destroy(); if(chartMet) chartMet.destroy();
        const fluxoData = {}; financas.forEach(f => { const dia = formatDate(f.dataISO); if(!fluxoData[dia]) fluxoData[dia] = 0; fluxoData[dia] += (f.tipo==='entrada'?f.valor:-f.valor); });
        chartFin = new Chart(document.getElementById('graficoFinanceiro'), { type: 'line', data: { labels: Object.keys(fluxoData).slice(-7), datasets: [{ label: 'Saldo', data: Object.values(fluxoData).slice(-7), borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.05)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: { grid: {display:false} }, y: { border: {dash:[5,5]} } } } });
        const metodosData = {}; financas.filter(f=>f.tipo==='entrada').forEach(f => { const m = f.metodo || 'Outros'; if(!metodosData[m]) metodosData[m]=0; metodosData[m]+=f.valor; });
        chartMet = new Chart(document.getElementById('graficoMetodos'), { type: 'doughnut', data: { labels: Object.keys(metodosData), datasets: [{ data: Object.values(metodosData), backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'right'} } } });
    }

    function setupVoiceRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'pt-BR'; recognition.interimResults = false;
            recognition.onstart = function() { document.getElementById('btn-mic').classList.add('bg-danger','text-white'); };
            recognition.onend = function() { document.getElementById('btn-mic').classList.remove('bg-danger','text-white'); };
            recognition.onresult = function(event) { document.getElementById('chat-input').value = event.results[0][0].transcript; enviarMsgIA(); };
        } else { document.getElementById('btn-mic').style.display = 'none'; }
    }
    function toggleMic() { if(recognition) recognition.start(); }
    function setIAMode(mode) { iaMode = mode; document.getElementById('chat-output').innerHTML = ''; if(mode === 'comando') appendMsg('bot', '<b>Nexus AI</b>:<br>Diga "Vendi 2 cocas" ou "Gastei 50 com luz".'); }

    async function processarComandoNativo(msg) {
        const m = norm(msg);
        const batch = isDemoMode ? MockDB : db.batch();

        if (iaContext && iaContext.state === 'waiting_confirmation') {
            if (m.includes('sim') || m.includes('pode') || m.includes('quero')) { iaContext.state = 'waiting_details'; return `Ok! Digite a <b>QTD, CUSTO e VENDA</b> separados por espa√ßo.<br>Exemplo: <i>10 5.00 15.00</i>`; } 
            else { iaContext = null; return "Cancelado."; }
        }

        if (iaContext && iaContext.state === 'waiting_details') {
            const details = m.match(/(\d+)\s+(\d+[.,]?\d*)\s+(\d+[.,]?\d*)/);
            if (details) {
                const qtdInformada = parseInt(details[1]); 
                const custo = parseFloat(details[2].replace(',', '.')); 
                const venda = parseFloat(details[3].replace(',', '.')); 
                const nomeProd = iaContext.productName;
                const newProdRef = getUserRef("produtos").doc();
                
                let qtdFinal = qtdInformada;
                if (iaContext.action === 'sell') {
                    const total = venda * iaContext.qty;
                    qtdFinal = qtdInformada - iaContext.qty;
                    batch.set(getUserRef("financas").doc(), { tipo: 'entrada', desc: `${iaContext.qty}x ${nomeProd} (Novo)`, metodo: 'Dinheiro', valor: total, dataISO: new Date().toISOString() });
                    batch.set(getUserRef("historico").doc(), { tipo: 'Venda', desc: `${iaContext.qty}x ${nomeProd}`, valor: total, data: new Date().toISOString() });
                }
                
                batch.set(newProdRef, { nome: nomeProd, qtd: qtdFinal, custo: custo, venda: venda, min: 5 }); 
                if(!isDemoMode) await batch.commit(); 
                iaContext = null; 
                if(isDemoMode) atualizarDashboard(); 
                return `‚úÖ <b>Produto Criado!</b><br>${esc(nomeProd)}<br>Estoque: ${qtdFinal}`;
            } else { return "Formato inv√°lido. Digite: QTD CUSTO VENDA (ex: 10 5.00 15.00)"; }
        }

        const regexRepor = /(?:adicionar|repor|entrada)\s+(\d+)\s+(?:unidades? de|garrafas? de|no estoque de)?\s*(.+)/;
        const matchRepor = m.match(regexRepor);
        if(matchRepor && matchRepor[2]) {
            const qtd = parseInt(matchRepor[1]); const termo = matchRepor[2].trim(); const produto = produtos.find(p => norm(p.nome).includes(termo));
            if(produto) { batch.update(getUserRef("produtos").doc(produto.id), {qtd: produto.qtd + qtd}); if(!isDemoMode) await batch.commit(); return `‚úÖ <b>Estoque Atualizado!</b><br>+${qtd} em "${esc(produto.nome)}". Total: ${produto.qtd + qtd}.`; }
        }

        const regexVenda = /(?:vendi|saiu|venda|sa√≠ram|vendas|saida)\s*(\d+)\s*(?:unidades? de|garrafas? de)?\s*(.+)/;
        const matchVenda = m.match(regexVenda);
        if (matchVenda && matchVenda[2]) {
            const qtd = parseInt(matchVenda[1]); const termo = matchVenda[2].trim().replace(/\s+(por|no|na|dinheiro|pix)$/, ''); const produto = produtos.find(p => norm(p.nome).includes(termo));
            if (produto) {
                const total = produto.venda * qtd;
                batch.update(getUserRef("produtos").doc(produto.id), {qtd: produto.qtd - qtd});
                batch.set(getUserRef("financas").doc(), {tipo: 'entrada', desc: `${qtd}x ${produto.nome} (Voz)`, metodo: 'Dinheiro', valor: total, dataISO: new Date().toISOString()});
                batch.set(getUserRef("historico").doc(), {tipo: 'Venda', desc: `${qtd}x ${produto.nome}`, valor: total, data: new Date().toISOString()});
                if(!isDemoMode) await batch.commit(); atualizarDashboard(); return `‚úÖ <b>Venda Confirmada!</b><br>${esc(produto.nome)} x${qtd}`;
            } else { iaContext = { state: 'waiting_confirmation', productName: termo, qty: qtd, action: 'sell' }; return `‚ö†Ô∏è Produto <b>"${esc(termo)}"</b> n√£o existe.<br>Deseja cadastrar agora? (Sim)`; }
        }
        
        const regexGasto = /(?:saida|gastei|paguei|despesa|gasto|pagamento|retirada)(?:\s+de)?\s+(\d+)\s*(?:reais)?\s*(?:com|em|no|na)?\s*(.*)/;
        const matchGasto = m.match(regexGasto);
        if (matchGasto) {
            const valor = parseFloat(matchGasto[1]); let desc = matchGasto[2].trim().replace(/^(com|em|no|na|produtos|produto)\s+/, ''); if(!desc) desc = "Despesa Diversa";
            await addData("financas", {tipo:'saida', desc: `Despesa: ${desc}`, metodo:'Dinheiro', valor: valor, dataISO: new Date().toISOString()}, null);
            await log('Despesa', desc, valor); atualizarDashboard(); return `‚úÖ <b>Despesa Lan√ßada!</b><br>${esc(desc)} - ${formatCurrency(valor)}`;
        }
        return null;
    }

    async function enviarMsgIA() {
        const inp = document.getElementById('chat-input'); const msg = inp.value; if(!msg) return;
        appendMsg('user', esc(msg)); inp.value = ''; const loadingId = 'loading-'+Date.now();
        document.getElementById('chat-output').innerHTML += `<div id="${loadingId}" class="chat-msg chat-bot"><i class="fas fa-circle-notch fa-spin"></i> ...</div>`;
        if (iaMode === 'comando') { const local = await processarComandoNativo(msg); if(local) { document.getElementById(loadingId).remove(); appendMsg('bot', local); return; } }
        const apiKey = configEmpresa.apikey; let resposta = "Comando n√£o entendido. Tente 'Vendi X [nome]'.";
        if(apiKey && apiKey.length > 10) { try { const prompt = `Responda curto: ${msg}`; const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`; const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); if(res.ok) { const data = await res.json(); resposta = data.candidates[0].content.parts[0].text; } } catch(e) { resposta = "IA indispon√≠vel."; } }
        document.getElementById(loadingId).remove(); appendMsg('bot', marked.parse(resposta));
    }

    function appendMsg(role, html) { const div = document.createElement('div'); div.className = `chat-msg chat-${role} p-3 mb-2 small shadow-sm fade-in`; div.innerHTML = html; const c = document.getElementById('chat-output'); c.appendChild(div); c.scrollTop = c.scrollHeight; }

    const formatCurrency = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
    const formatDate = d => new Date(d).toLocaleDateString('pt-BR');
    function selectPagamento(tipo, elem) { document.getElementById('pag-metodo').value = tipo; document.querySelectorAll('.btn-pagamento').forEach(b => b.classList.remove('active', 'border-primary', 'text-primary')); elem.classList.add('active', 'border-primary', 'text-primary'); if(tipo==='Fiado') document.getElementById('cliente-pdv').focus(); }
    async function log(t,d,v){ await getUserRef("historico").add({tipo:t,desc:d,valor:v,data:new Date().toISOString()}) }
    async function addData(col,d,btn){ if(btn)setLoading(btn,true); await getUserRef(col).add(d); if(btn){setLoading(btn,false); bootstrap.Modal.getInstance(btn.closest('.modal')).hide(); Swal.fire({toast:true,icon:'success',title:'Salvo',position:'top-end',showConfirmButton:false,timer:1000});} }
    function del(col,id){ Swal.fire({title:'Tem certeza?',icon:'warning',showCancelButton:true,confirmButtonColor:'#ef4444', confirmButtonText: 'Sim, excluir'}).then(r=>{if(r.isConfirmed)getUserRef(col).doc(id).delete()}) }
    function carregarConfigUI() { document.getElementById('conf-nome').value=configEmpresa.nome||''; document.getElementById('conf-cnpj').value=configEmpresa.cnpj||''; document.getElementById('conf-end').value=configEmpresa.end||''; document.getElementById('conf-msg').value=configEmpresa.msg||''; document.getElementById('conf-apikey').value=configEmpresa.apikey||''; }
    async function salvarConfig(btn) { setLoading(btn,true); const cfg={ nome:document.getElementById('conf-nome').value, cnpj:document.getElementById('conf-cnpj').value, end:document.getElementById('conf-end').value, msg:document.getElementById('conf-msg').value, apikey:document.getElementById('conf-apikey').value, }; await getConfigRef().set(cfg); setLoading(btn,false); location.reload(); }
    function navTo(id) { document.querySelectorAll('.section').forEach(el=>el.classList.add('hide')); document.getElementById(id).classList.remove('hide'); toggleMenu(true); if(id==='dashboard') atualizarDashboard(); if(id==='estoque') renderEstoque(false); if(id==='relatorios') renderRelatorios(); }
    function toggleMenu(force){ const sb=document.getElementById('sidebar'), ov=document.getElementById('overlay'); if(force){sb.classList.remove('show');ov.classList.remove('show')}else{sb.classList.toggle('show');ov.classList.toggle('show')} }
    
    async function resetarSistema() {
        if(isDemoMode) { location.reload(); return; }
        const { value: confirmacao } = await Swal.fire({
            title: 'RESETAR SISTEMA?',
            text: "Digite DELETAR para confirmar a exclus√£o total.",
            input: 'text', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Apagar Tudo'
        });

        if (confirmacao === 'DELETAR') {
            Swal.fire({title: 'Resetando...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
            const collections = ["produtos", "financas", "historico", "fiados", "os", "contas"];
            for (const col of collections) {
                const snapshot = await getUserRef(col).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
            Swal.fire('Sistema Resetado', 'Come√ßando do zero.', 'success').then(() => location.reload());
        }
    }

    function renderEstoque(critico=false){ 
        const t=document.getElementById('lista-estoque'); 
        const termo = norm(document.getElementById('busca-estoque').value); 
        t.innerHTML = produtos.filter(p => { if(critico && p.qtd>(p.min||5)) return false; if(termo && !norm(p.nome).includes(termo)) return false; return true; }).map(p => { 
            const m = p.venda>0?(((p.venda-p.custo)/p.venda)*100).toFixed(0):0; 
            return `<tr>
                <td class="ps-4 text-dark fw-bold">${esc(p.nome)}</td>
                <td><span class="badge ${p.qtd<=(p.min||5)?'bg-danger':'bg-success'} rounded-pill">${p.qtd}</span></td>
                <td>${formatCurrency(p.custo)}</td>
                <td>${formatCurrency(p.venda)}</td>
                <td class="fw-bold ${m<30?'text-danger':'text-success'}">${m}%</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-light border me-1 rounded-pill" onclick="abrirModalEditarProduto('${p.id}')"><i class="fas fa-pen text-secondary"></i></button>
                    <button class="btn btn-sm btn-light border text-danger rounded-pill" onclick="del('produtos','${p.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`; 
        }).join(''); 
    }
    
    function abrirModalProduto(){ 
        document.getElementById('modal-prod-titulo').innerText = "Novo Produto";
        document.getElementById('prod-id').value = ''; 
        document.getElementById('prod-nome').value=''; 
        document.getElementById('prod-qtd').value='';
        document.getElementById('prod-min').value='5';
        document.getElementById('prod-custo').value='';
        document.getElementById('prod-venda').value='';
        new bootstrap.Modal(document.getElementById('modalProduto')).show(); 
    }

    function abrirModalEditarProduto(id) {
        const p = produtos.find(x => x.id === id);
        document.getElementById('modal-prod-titulo').innerText = "Editar Produto";
        document.getElementById('prod-id').value = id;
        document.getElementById('prod-nome').value = p.nome;
        document.getElementById('prod-qtd').value = p.qtd;
        document.getElementById('prod-min').value = p.min || 5;
        document.getElementById('prod-custo').value = p.custo;
        document.getElementById('prod-venda').value = p.venda;
        new bootstrap.Modal(document.getElementById('modalProduto')).show();
    }

    async function salvarProduto(btn){ 
        const id = document.getElementById('prod-id').value;
        const nome=document.getElementById('prod-nome').value; 
        const qtd=parseInt(document.getElementById('prod-qtd').value)||0;
        const custo=parseFloat(document.getElementById('prod-custo').value)||0;
        const venda=parseFloat(document.getElementById('prod-venda').value)||0;
        const min=parseInt(document.getElementById('prod-min').value)||5;
        
        if(!nome)return;
        setLoading(btn, true);
        
        if(id) {
            await getUserRef("produtos").doc(id).update({nome, qtd, custo, venda, min});
            Swal.fire({toast:true, icon:'success', title:'Atualizado', position:'top-end', showConfirmButton:false, timer:1000});
        } else {
            await getUserRef("produtos").add({nome, qtd, custo, venda, min});
            Swal.fire({toast:true, icon:'success', title:'Criado', position:'top-end', showConfirmButton:false, timer:1000});
        }
        setLoading(btn, false);
        bootstrap.Modal.getInstance(document.getElementById('modalProduto')).hide();
    }

    function renderFinancas(){ const t=document.getElementById('lista-financa'); const termo = norm(document.getElementById('busca-financa').value); t.innerHTML = financas.filter(f => !termo || norm(f.desc).includes(termo)).map(f => `<tr><td class="ps-4"><i class="fas ${f.tipo==='entrada'?'fa-arrow-up text-success':'fa-arrow-down text-danger'}"></i></td><td class="text-dark">${esc(f.desc)}</td><td class="fw-bold ${f.tipo==='entrada'?'text-success':'text-danger'}">${formatCurrency(f.valor)}</td><td class="text-muted small">${formatDate(f.dataISO)}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border text-danger rounded-pill" onclick="del('financas','${f.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); }
    
    function renderOS(){ 
        const c=document.getElementById('lista-os'); 
        c.innerHTML = osList.map(o => { 
            const statusBadge = o.concluido 
                ? `<span class="badge bg-success rounded-pill">Conclu√≠do</span>` 
                : `<span class="badge bg-warning text-dark rounded-pill">Pendente</span>`;
            
            return `<tr>
                <td class="ps-4 fw-bold text-dark">${esc(o.cliente)}</td>
                <td><small class="text-muted">${esc(o.desc).substring(0,30)}...</small></td>
                <td>${o.prazo ? formatDate(o.prazo) : '-'}</td>
                <td class="fw-bold text-primary">${o.valor > 0 ? formatCurrency(o.valor) : 'A OR√áAR'}</td>
                <td>${statusBadge}</td>
                <td class="text-end pe-4">
                    ${!o.concluido ? `<button class="btn btn-sm btn-outline-success rounded-pill me-1" onclick="concluirOS('${o.id}', ${o.valor}, '${esc(o.cliente)}')"><i class="fas fa-check"></i></button>` : ''}
                    <button class="btn btn-sm btn-light border rounded-pill me-1" onclick="abrirModalEditarOS('${o.id}')"><i class="fas fa-pen text-secondary"></i></button>
                    <button class="btn btn-sm btn-light border rounded-pill me-1" onclick="imprimirOS('${o.id}')"><i class="fas fa-print text-secondary"></i></button>
                    <button class="btn btn-sm btn-light border text-danger rounded-pill" onclick="del('os','${o.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`; 
        }).join(''); 
    }
    
    function abrirModalOS(){ new bootstrap.Modal(document.getElementById('modalOS')).show(); }
    function salvarOS(btn){ const val = parseFloat(document.getElementById('os-valor').value)||0; addData("os",{cliente:document.getElementById('os-cliente').value,desc:document.getElementById('os-desc').value,valor:val,prazo:document.getElementById('os-data').value,dataCriacao:new Date().toISOString(),concluido:false},btn); }
    
    async function concluirOS(id, valor, cliente) { 
        if(!confirm('Confirmar conclus√£o?')) return; 
        
        const batch = isDemoMode ? MockDB : db.batch();
        batch.update(getUserRef("os").doc(id), {concluido: true});
        
        if(valor > 0) {
            batch.set(getUserRef("financas").doc(), {tipo:'entrada', desc:`Servi√ßo O.S. - ${cliente}`, metodo:'Dinheiro', valor:valor, dataISO:new Date().toISOString()});
            batch.set(getUserRef("historico").doc(), {tipo:'Servi√ßo', desc:`O.S. Conclu√≠da - ${cliente}`, valor:valor, data:new Date().toISOString()});
        }
        
        if(!isDemoMode) await batch.commit();
        if(isDemoMode) { renderOS(); atualizarDashboard(); }
        Swal.fire('Conclu√≠do', 'OS Fechada e Financeiro Atualizado.', 'success'); 
    }

    function imprimirOS(id) { const o = osList.find(i => i.id === id); const html = `<div class="folha-os"><div class="os-header"><div><h2 style="margin:0; font-weight:bold;">${esc(configEmpresa.nome)}</h2><p style="margin:0; font-size:12px;">${esc(configEmpresa.end)} | ${esc(configEmpresa.cnpj)}</p></div><div style="text-align:right;"><h3 style="margin:0;">O.S. #${id.substring(0,5).toUpperCase()}</h3><p style="margin:0; font-size:12px;">Data: ${formatDate(o.dataCriacao)}</p></div></div><div class="os-box"><p><strong>Cliente:</strong> ${esc(o.cliente)}</p><p><strong>Prazo Previsto:</strong> ${o.prazo ? formatDate(o.prazo) : 'A combinar'}</p></div><div class="os-box" style="min-height:100px;"><p><strong>Descri√ß√£o do Defeito / Servi√ßo:</strong></p><p>${esc(o.desc).replace(/\n/g, '<br>')}</p></div><div class="os-box" style="margin-top:20px; text-align:right;"><p style="font-size:14px;">Valor Total</p><h2 style="margin:0;">${o.valor > 0 ? formatCurrency(o.valor) : 'A OR√áAR'}</h2></div><div class="os-box" style="margin-top:20px; border:none; padding:0;"><p style="font-size:10px;">TERMOS: A garantia cobre apenas o servi√ßo realizado. Equipamentos n√£o retirados em 90 dias ser√£o descartados.</p></div><div style="display:flex; justify-content:space-between; margin-top:50px;"><div class="os-assinatura">Assinatura do T√©cnico</div><div class="os-assinatura">Assinatura do Cliente</div></div></div>`; imprimirConteudo(html); }
    function abrirModalEditarOS(id) { const o = osList.find(i => i.id === id); document.getElementById('edit-os-id').value = id; document.getElementById('edit-os-cliente').value = o.cliente; document.getElementById('edit-os-desc').value = o.desc; document.getElementById('edit-os-valor').value = o.valor; document.getElementById('edit-os-data').value = o.prazo || ''; new bootstrap.Modal(document.getElementById('modalEditarOS')).show(); }
    async function salvarEdicaoOS(btn) { setLoading(btn, true); const id = document.getElementById('edit-os-id').value; const desc = document.getElementById('edit-os-desc').value; const valor = parseFloat(document.getElementById('edit-os-valor').value) || 0; const prazo = document.getElementById('edit-os-data').value; await getUserRef("os").doc(id).update({ desc, valor, prazo }); setLoading(btn, false); bootstrap.Modal.getInstance(document.getElementById('modalEditarOS')).hide(); Swal.fire('Atualizado', 'Ordem de Servi√ßo editada.', 'success'); }

    function renderContas() { 
        const t = document.getElementById('lista-contas'); 
        t.innerHTML = contas.map(c => `<tr>
            <td class="ps-4 fw-bold text-muted">${c.venc}</td>
            <td>${esc(c.desc)} ${c.recorrente ? '<i class="fas fa-sync-alt text-info ms-1" title="Mensal"></i>' : ''}</td>
            <td class="fw-bold text-dark">${formatCurrency(c.valor)}</td>
            <td><span class="badge bg-warning text-dark rounded-pill">Pendente</span></td>
            <td class="text-end pe-4">
                <button class="btn btn-sm btn-success rounded-pill px-3 me-1" onclick="pagarConta('${c.id}')"><i class="fas fa-check me-1"></i>Pagar</button> 
                <button class="btn btn-sm btn-light border text-danger rounded-pill" onclick="del('contas','${c.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`).join(''); 
    }

    function abrirModalConta() { 
        document.getElementById('conta-desc').value = '';
        document.getElementById('conta-valor').value = '';
        document.getElementById('conta-venc').value = '';
        document.getElementById('conta-recorrente').checked = false;
        new bootstrap.Modal(document.getElementById('modalConta')).show(); 
    }

    async function salvarConta(btn) { 
        const desc = document.getElementById('conta-desc').value;
        const valor = parseFloat(document.getElementById('conta-valor').value);
        const venc = document.getElementById('conta-venc').value;
        const recorrente = document.getElementById('conta-recorrente').checked;
        
        if(!desc || !valor || !venc) return Swal.fire('Erro', 'Preencha todos os campos', 'warning');
        
        addData("contas", {desc, valor, venc, recorrente}, btn); 
    }

    async function pagarConta(id) { 
        if(!confirm('Confirmar pagamento?')) return; 
        const c = contas.find(x => x.id === id);
        
        await getUserRef("contas").doc(id).delete(); 
        const dataISO = new Date().toISOString();
        await addData("financas", {tipo:'saida', desc:`Pagamento: ${c.desc}`, metodo:'Dinheiro', valor: c.valor, dataISO}, null);
        await log('Pagamento', c.desc, c.valor);

        if(c.recorrente) {
            let nextDate;
            if(c.venc.includes('-')) {
                const parts = c.venc.split('-');
                nextDate = new Date(parts[0], parts[1]-1, parts[2]); 
            } else {
                const parts = c.venc.split('/');
                nextDate = new Date(parts[2], parts[1]-1, parts[0]);
            }
            nextDate.setMonth(nextDate.getMonth() + 1);
            const nextVencStr = nextDate.toISOString().split('T')[0];
            await getUserRef("contas").add({ desc: c.desc, valor: c.valor, venc: nextVencStr, recorrente: true });
            Swal.fire('Pago', 'Conta baixada e pr√≥xima fatura gerada.', 'success');
        } else {
            Swal.fire('Pago', 'Conta baixada e debitada do caixa.', 'success'); 
        }
    }

    function imprimirExtrato() { const tabela = document.getElementById('tabela-extrato').outerHTML; const html = `<div style="text-align:center; margin-bottom:20px;"><h3>${esc(configEmpresa.nome)}</h3><p>Relat√≥rio Detalhado</p><hr></div>${tabela}<div style="margin-top:20px; text-align:right;">Emitido em: ${new Date().toLocaleString()}</div>`; imprimirConteudo(html); }
    function imprimirConteudo(html) { const area = document.getElementById('area-impressao'); area.innerHTML = html; area.classList.remove('hide'); setTimeout(() => { window.print(); setTimeout(() => area.classList.add('hide'), 500); }, 100); }
    function exportarDados(tipo) { let dados = tipo === 'produtos' ? produtos : financas; let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; if(tipo === 'produtos') { csvContent += "Nome,Quantidade,Custo,Venda\n"; dados.forEach(d => { csvContent += `"${d.nome}",${d.qtd},${d.custo},${d.venda}\n`; }); } else { csvContent += "Data,Descri√ß√£o,Tipo,Valor,M√©todo\n"; dados.forEach(d => { csvContent += `"${formatDate(d.dataISO)}","${d.desc}",${d.tipo},${d.valor},"${d.metodo}"\n`; }); } const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `relatorio_${tipo}.csv`); document.body.appendChild(link); link.click(); }
    function processarImagemOCR(input) { const file = input.files[0]; if(!file) return; document.getElementById('ocr-progress').classList.remove('hide'); const origem = document.getElementById('ocr-origem').value; Tesseract.recognize(file, 'por', { logger: m => console.log(m) }).then(({ data: { text } }) => { document.getElementById('ocr-progress').classList.add('hide'); bootstrap.Modal.getInstance(document.getElementById('modalOCR')).hide(); const valorMatch = text.match(/TOTAL.*?R\$\s?([\d,.]+)/i) || text.match(/VALOR.*?([\d,.]+)/i) || text.match(/R\$\s?([\d,.]+)/i); const dataMatch = text.match(/(\d{2}\/\d{2}\/\d{4})/); const cnpjMatch = text.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/); let valor = 0; if(valorMatch) valor = parseFloat(valorMatch[1].replace('.','').replace(',','.')); let desc = cnpjMatch ? `Fornecedor CNPJ: ${cnpjMatch[0]}` : "Boleto/Nota (Scanner)"; let data = dataMatch ? dataMatch[0] : new Date().toLocaleDateString('pt-BR'); if(origem === 'contas') { abrirModalConta(); setTimeout(() => { document.getElementById('conta-desc').value = desc; document.getElementById('conta-valor').value = valor; document.getElementById('conta-venc').value = data; Swal.fire({toast:true, icon:'success', title:'Scanner Conclu√≠do! Confirme os dados.', position:'top'}); }, 500); } }); }
    function abrirModalOCR(origem) { document.getElementById('ocr-origem').value = origem; document.getElementById('ocr-result').classList.add('hide'); document.getElementById('ocr-file').value = ''; new bootstrap.Modal(document.getElementById('modalOCR')).show(); }
    
    // Anima√ß√£o de entrada
    setTimeout(() => { document.getElementById('global-loader').classList.add('hide'); }, 800);
    navTo('dashboard');
</script>
</body>
</html>
